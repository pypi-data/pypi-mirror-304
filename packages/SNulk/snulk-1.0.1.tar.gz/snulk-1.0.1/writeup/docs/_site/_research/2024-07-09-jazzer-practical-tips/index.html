<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Practical Jazzer for the Snazzy Fuzzer | Security Lab</title>
<meta name="description" content="We will review some lessons learned and tips for effectively fuzzing your applications with Jazzer.">


  <meta name="author" content="Sam Shahsavar">
  
  <meta property="article:author" content="Sam Shahsavar">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Security Lab">
<meta property="og:title" content="Practical Jazzer for the Snazzy Fuzzer">
<meta property="og:url" content="http://localhost:8080/_research/2024-07-09-jazzer-practical-tips/">


  <meta property="og:description" content="We will review some lessons learned and tips for effectively fuzzing your applications with Jazzer.">





  <meta name="twitter:site" content="@SNSecurityLab">
  <meta name="twitter:title" content="Practical Jazzer for the Snazzy Fuzzer">
  <meta name="twitter:description" content="We will review some lessons learned and tips for effectively fuzzing your applications with Jazzer.">
  <meta name="twitter:url" content="http://localhost:8080/_research/2024-07-09-jazzer-practical-tips/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2024-07-08T00:00:00-07:00">





  

  


<link rel="canonical" href="http://localhost:8080/_research/2024-07-09-jazzer-practical-tips/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "ServiceNow",
      "url": "http://localhost:8080/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/rouge.css">

<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>
<link rel="preload" as="font" href="/assets/fonts/gilroy-regular-webfont.woff2" type="font/woff2" crossorigin="anonymous"/>
<link rel="preload" as="font" href="/assets/fonts/gilroy-semibold-webfont.woff2" type="font/woff2" crossorigin="anonymous"/>
<link rel="preload" as="font" href="/assets/fonts/gilroy-bold-webfont.woff2" type="font/woff2" crossorigin="anonymous"/>
<link rel="preload" as="font" href="/assets/fonts/fira-mono-regular-latin.woff2" type="font/woff2" crossorigin="anonymous"/>

<style>
@font-face {
  font-family: GilroyRegular;
  font-style: normal;
  font-weight: 400;
  src: url(/assets/fonts/gilroy-regular-webfont.woff2) format("woff2"),url(/assets/fonts/gilroy-regular-webfont.woff) format("woff");
  font-display: swap;
}

@font-face {
  font-family: GilroySemiBold;
  font-style: normal;
  font-weight: 400;
  src: url(/assets/fonts/gilroy-semibold-webfont.woff2) format("woff2"),url(/assets/fonts/gilroy-semibold-webfont.woff) format("woff");
  font-display: swap;
}

@font-face {
  font-family: GilroyBold;
  font-style: normal;
  font-weight: 400;
  src: url(/assets/fonts/gilroy-bold-webfont.woff2) format("woff2"),url(/assets/fonts/gilroy-bold-webfont.woff) format("woff");
  font-display: swap;
}

@font-face {
  font-family: 'Fira Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(/assets/fonts/fira-mono-regular-latin.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Fira Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(/assets/fonts/fira-mono-regular-latin-ext.woff2) format('woff2');
  unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Fira Mono';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: url(/assets/fonts/fira-mono-bold-latin.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Fira Mono';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: url(/assets/fonts/fira-mono-bold-latin-ext.woff2) format('woff2');
  unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
</style>



    <!-- start custom head snippets -->
<script src="https://assets.adobedtm.com/a441b904b50e/99538f40e7c0/launch-3dcaf3475e9d.min.js" async></script>
<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<style>
  @media screen and (width >= 725px) {
    .small-screen {
      display: none;
    }
    .large-screen { }
  }
  @media screen and (width < 725px) {
    .small-screen { }
    .large-screen {
      display: none;
    }
  }

  a {
    /*font-family: "Source Sans Pro", "Helvetica Neue", Helvetica, Arial, sans-serif;*/
    font-family: Gilroy-Medium, "Century Gothic", CenturyGothic, sans-serif;
    font-size: 1rem;
    font-weight: 400;
  }

  .masthead__menu-item a {
    font-size: 0.8rem;
    margin: 0 0.25rem 0 0.25rem;
  }

  .masthead__menu-item_block a {
    white-space: nowrap;
    font-size: 0.8rem;
    color: rgb(255, 255, 255);
    background-color: rgb(41, 62, 64);
    padding-bottom: 0.4rem;
    padding-left: 0.6rem;
    padding-right: 0.6rem;
    padding-top: 0.4rem;
    position: relative;
  }

  .site-brand {
    align-items: center;
    background-color: rgba(0, 0, 0, 0);
    box-sizing: border-box;
    color: rgb(255, 255, 255);
    cursor: pointer;
    /*display: flex;*/
    /*font-family: "Source Sans Pro", "Helvetica Neue", Helvetica, Arial, sans-serif;*/
    font-family: Gilroy-Medium, "Century Gothic", CenturyGothic, sans-serif;
    font-size: 1rem;
    font-weight: 400;
    height: 41px;
    line-height: 25px;
    margin-bottom: 0px;
    margin-left: 0px;
    margin-right: 16px;
    margin-top: 0px;
    outline-color: rgb(255, 255, 255);
    outline-style: none;
    outline-width: 0px;
    padding-bottom: 5px;
    padding-left: 9px;
    padding-right: 0px;
    padding-top: 5px;
    text-align: left;
    text-decoration-color: rgb(255, 255, 255);
    text-decoration-line: none;
    text-decoration-style: solid;
    text-decoration-thickness: auto;
    text-size-adjust: 100%;
    text-wrap: nowrap;
    touch-action: manipulation;
    white-space-collapse: collapse;
    width: auto;
    -webkit-box-align: center;
    -webkit-box-direction: normal;
    -webkit-font-smoothing: antialiased;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  }
  .small-screen a.site-brand {
    margin: 0px;
    padding: 0px;
  }

  .logo {
    border-right: 1px solid #000;
    height: 1.5rem;
    margin-right: 12px;
    min-width: 8rem;
    padding-bottom: 8px;
    padding-right: 12px;
    /*width: 180px;*/
  }

  .masthead__site-title {
    color: rgb(0, 0, 0);
    /*font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;*/
    font-family: Gilroy-Medium, "Century Gothic", CenturyGothic, sans-serif;
    font-weight: bold;
    font-size: 1rem;
  }

  ul {
    align-items: center;
  }
</style>

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu large-screen">
      <nav id="site-nav" class="greedy-nav large-screen">
        <a class="site-brand" href="/">
          
          <img class="logo" src="/assets/images/servicenow-header-logo.svg" alt="Security Lab">
          
          <span class="masthead__site-title">Security Lab</span>
        </a>
        <span class="visible-links">
          <span class="masthead__menu-item"><a href="/cvd" >CVD</a><a href="/snadvisories/" >SN Advisories</a><a href="/research/" >Research Blog</a><a href="/archive/" >Archive</a></span>
          <span class="masthead__menu-item_block">
            <a href="/get-involved" >Get Involved!</a>
          </span>
          
          <button class="search__toggle" type="button">
            <span class="visually-hidden">Toggle search</span>
            <img src="/assets/images/BUS_search-icon.svg" height="28" width="28" alt="Search">
          </button>
          
        </span>
      </nav>
    </div>
    <div class="masthead__menu small-screen">
      <nav id="site-nav" class="greedy-nav small-screen">
        <center><a class="site-brand" href="/">
          
          <img class="logo" src="/assets/images/servicenow-header-logo.svg" alt="Security Lab">
          
          <span class="masthead__site-title">Security Lab</span>
        </a></center>
        <center>
        <span class="visible-links">
          <span class="masthead__menu-item"><a href="/cvd" >CVD</a><a href="/snadvisories/" >SN Advisories</a><a href="/research/" >Research Blog</a><a href="/archive/" >Archive</a></span>
          <br>
          <span class="masthead__menu-item_block">
            <a href="/get-involved" >Get Involved!</a>
          </span>
          
          <button class="search__toggle" type="button">
            <span class="visually-hidden">Toggle search</span>
            <img src="/assets/images/BUS_search-icon.svg" height="28" width="28" alt="Search">
          </button>
          
        </span>
        </center>
      </nav>

    </div>
  </div>
</div>


    <div class="initial-content">
      







<div class="page__hero"
  style=" background-image: url('');"
>
  
    <img src="" alt="Practical Jazzer for the Snazzy Fuzzer" class="page__hero-image">
  
  
</div>



  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:8080/" itemprop="item"><span itemprop="name" class="breadcrumb_item">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">></span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/_research" itemprop="item"><span itemprop="name" class="breadcrumb_item">_research</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">></span>
      
    
      
      
        <li class="current">[ Practical Jazzer for the Snazzy Fuzzer ]</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Practical Jazzer for the Snazzy Fuzzer">
    <meta itemprop="description" content="We will review some lessons learned and tips for effectively fuzzing your applications with Jazzer.">
    <meta itemprop="datePublished" content="2024-07-08T00:00:00-07:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Practical Jazzer for the Snazzy Fuzzer
</h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#extra-fuzz-target-methods">Extra Fuzz Target Methods</a></li><li><a href="#method-hooks--classpath">Method Hooks &amp; Classpath</a></li><li><a href="#timeouts">Timeouts</a></li><li><a href="#advanced-run-options">Advanced Run Options</a><ul><li><a href="#disable-existing-hooks">Disable Existing Hooks</a></li><li><a href="#instrumentation-includes">Instrumentation Includes</a></li><li><a href="#keep-going">Keep Going</a></li></ul></li><li><a href="#final-thoughts">Final Thoughts</a></li></ul>

            </nav>
            
          </aside>
        
        <p>Fuzzing is an automated methodology that attempts to identify bugs within software, especially security vulnerabilities. 
We on the Security Research Team at ServiceNow utilize the fuzzer Jazzer internally for specific use cases.</p>

<blockquote>
  <p>Jazzer is a coverage-guided, in-process fuzzer for the JVM platform developed by Code Intelligence. It is based on 
libFuzzer and brings many of its instrumentation-powered mutation features to the JVM.<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup></p>
</blockquote>

<p>While Code Intelligence no longer maintains Jazzer, the fuzzer remains functional and available for use from
<a href="https://github.com/CodeIntelligenceTesting/jazzer">GitHub</a>.</p>

<p>When it comes to large-scale enterprise Java applications, throwing a fuzzer at some code is unlikely to identify 
interesting vulnerabilities. Instead, you need to think about application state and what sort of state indicates a 
potential security issue. After that, it’s a matter of wrangling a fuzzer to effectively identify that state.</p>

<p>Unfortunately, like many technical tools, the documentation for Jazzer is a little lighter than we’d like, and 
examples across the Internet leave a bit to be desired complexity-wise. In this post, we will share 
and compile some lessons learned and advanced tips for effectively making use of Jazzer with an enterprise Java 
application.</p>

<h2 id="extra-fuzz-target-methods">Extra Fuzz Target Methods</h2>

<p>If you stick to the <a href="https://github.com/CodeIntelligenceTesting/jazzer/tree/main/docs">documentation on GitHub</a> or 
<a href="https://www.code-intelligence.com/blog/how-to-write-fuzz-targets-for-java-applications">official blogs</a> from Code 
Insight, you might easily overlook some helpful methods available to you when creating fuzz targets.</p>

<p>The optional <code class="language-plaintext highlighter-rouge">fuzzerInitialize</code> method runs before iterating through calls of <code class="language-plaintext highlighter-rouge">fuzzerTestOneInput</code>. This 
initialization is especially helpful when fuzzing larger applications. You might need to prepare some of the normal 
application, but you don’t need to actually run the entire thing. Early initialization steps might also avoid 
unnecessary overhead on each call to <code class="language-plaintext highlighter-rouge">fuzzerTestOneInput</code>. A basic example is included below.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleApp</span><span class="o">{</span>
    
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">fuzzerInitialize</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"test.property.1"</span><span class="o">,</span> <span class="s">"false"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"test.db.name"</span><span class="o">,</span> <span class="s">"db_master"</span><span class="o">);</span>
    <span class="nc">TestProperties</span><span class="o">.</span><span class="na">loadSystemProperties</span><span class="o">();</span>
    <span class="nc">TestProperties</span><span class="o">.</span><span class="na">reload</span><span class="o">();</span>

    <span class="k">new</span> <span class="nf">TestEnvironment</span><span class="o">();</span>
  <span class="o">}</span>
  
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">fuzzerTestOneInput</span><span class="o">(</span><span class="nc">FuzzedDataProvider</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">consumeString</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
    
    <span class="c1">//Do something....</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In this example, we set some system properties, load those properties within the application context, and then 
prepare a mock application state with <code class="language-plaintext highlighter-rouge">new TestEnvironment()</code>. All of this will wildly differ depending on the 
minimum components your application require to run for fuzzing.</p>

<p>In a similar vein, optional method <code class="language-plaintext highlighter-rouge">fuzzerTearDown</code> can be used to clean up resources after the completion of a 
fuzzing run.</p>

<h2 id="method-hooks--classpath">Method Hooks &amp; Classpath</h2>

<p>With a memory safe language like Java, you’re unlikely to be interested in fuzzing for memory corruption 
vulnerabilities. Additionally, an enterprise Java application is less likely to be as affected by denial of service 
conditions. So you’re generally going to be most interested in fuzzing for particular application states that 
indicate specific types of vulnerabilities only relevant in the context of your application.</p>

<p>Code Intelligence provides a <a href="https://www.code-intelligence.com/blog/on-the-fuzzing-hook">decent resource</a> on using 
method hooks to detect these sort of application states. Still, the devil is in the details.</p>

<p>Method hooks themselves must be built and provided in a separate JAR file from the fuzzing target. It’s an easy to 
miss detail, but it prevents all sorts of access and classpath issues down the road. So a basic run example might 
look like this:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">--cp</span><span class="o">=</span>jazzer_standalone.jar:target.jar:hook.jar <span class="se">\</span>
com.code_intelligence.jazzer.Jazzer <span class="se">\</span>
<span class="nt">--target_class</span><span class="o">=</span>sn.securityresearch.fuzzing.target.ExampleApp <span class="se">\</span>
<span class="nt">--custom_hooks</span><span class="o">=</span>sn.securityresearch.fuzzing.hooks.ExampleHook
</code></pre></div></div>

<p>Second, during runtime, method hooks themselves appear to be limited in scope to system level JARs. This occurs 
whether or not the method hook itself was compiled with other JARs in its classpath and those same JARs are 
available on the classpath provided to Jazzer.</p>

<p>So, when you’re attempting to peek at your application state from a method hook, you might find yourself limited in 
the classes you would normally use to do so within the application itself. What’s the alternative then? Reflection!</p>

<p>In a slightly contrived example, imagine we have an application that allows users to run certain types of script. 
Low privilege users get access to a restricted script environment, normally the <code class="language-plaintext highlighter-rouge">UserContext</code> class, which contains a 
limited set of APIs. Admin level users get access to the entire script environment, normally the <code class="language-plaintext highlighter-rouge">AdminContext</code> 
class, which contains the full set of APIs. We’ve created a before-type method hook at the actual lower level script API 
invoker,<code class="language-plaintext highlighter-rouge">APIRunner.handleInvocation</code> to attempt to detect scenarios where certain script has escaped the low 
privilege context <code class="language-plaintext highlighter-rouge">UserContext</code> and entered the privileged <code class="language-plaintext highlighter-rouge">AdminContext</code>.</p>

<p>The normal method for <code class="language-plaintext highlighter-rouge">APIRunner.handleInvocation</code> looks like the following.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">APIRunner</span> <span class="o">{</span>
    
    <span class="kd">protected</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="nf">handleInvocation</span><span class="o">(</span><span class="nc">ScriptAPI</span> <span class="n">api</span><span class="o">,</span> <span class="nc">Runtime</span> <span class="n">rt</span><span class="o">,</span> <span class="nc">Context</span> <span class="n">cx</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Invoke API...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Within the application itself, it would be trivial to poke at the classes <code class="language-plaintext highlighter-rouge">Runtime</code> and <code class="language-plaintext highlighter-rouge">Context</code> and their 
respective fields to identify an escalation from a restricted to privileged environment. We simply could grab the 
type of <code class="language-plaintext highlighter-rouge">cx</code> and then compare with the <code class="language-plaintext highlighter-rouge">callContext</code> field from <code class="language-plaintext highlighter-rouge">rt</code>. Instead, since our method hook is unaware of 
<code class="language-plaintext highlighter-rouge">Runtime</code> and <code class="language-plaintext highlighter-rouge">Context</code>, we must use reflection to tease out the same information, resulting in a slightly less 
readable method hook like below.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleHook</span> <span class="o">{</span>

    <span class="nd">@MethodHook</span><span class="o">(</span>
            <span class="n">type</span> <span class="o">=</span> <span class="nc">HookType</span><span class="o">.</span><span class="na">BEFORE</span><span class="o">,</span>
            <span class="n">targetClassName</span> <span class="o">=</span> <span class="s">"com.securityresearch.script.APIRunner"</span><span class="o">,</span>
            <span class="n">targetMethod</span> <span class="o">=</span> <span class="s">"handleInvocation"</span>
    <span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">checkContextEscape</span><span class="o">(</span><span class="nc">MethodHandle</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">thisObject</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">arguments</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hookId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">detectContextEscape</span><span class="o">(</span><span class="n">arguments</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">detectContextEscape</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">arguments</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">String</span> <span class="n">currentContext</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">callContext</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Current Context</span>
            <span class="n">currentContext</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">();</span>

            <span class="c1">// Calling Context</span>
            <span class="nc">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">getClass</span><span class="o">();</span>
            <span class="nc">Field</span> <span class="n">f</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"callContext"</span><span class="o">);</span>
            <span class="n">f</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">callContext</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">arguments</span><span class="o">[</span><span class="mi">1</span><span class="o">]).</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">currentContext</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"AdminContext"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">callContext</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"UserContext"</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Jazzer</span><span class="o">.</span><span class="na">reportFindingFromHook</span><span class="o">(</span><span class="k">new</span> <span class="nc">FuzzerSecurityIssueCritical</span><span class="o">(</span><span class="s">"Possible Context Escape"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">@MethodHook</code> annotation tells Jazzer the class and method to target and first execute the custom method 
<code class="language-plaintext highlighter-rouge">checkContextEscape</code>. Since we do not directly have access to the <code class="language-plaintext highlighter-rouge">Context</code> object, we use reflection,
<code class="language-plaintext highlighter-rouge">arguments[2].getClass().getSimpleName()</code>, to identify the class of the <code class="language-plaintext highlighter-rouge">cx</code> argument. We similarly parse out the call 
context by inspecting the <code class="language-plaintext highlighter-rouge">callContext</code> field of the <code class="language-plaintext highlighter-rouge">Runtime</code> argument <code class="language-plaintext highlighter-rouge">rt</code>. We then compare the current and call context 
values we identified through reflection to see if a privilege escalation occurs. <code class="language-plaintext highlighter-rouge">Jazzer.reportFindingFromHook</code> is used
to report the state as a finding.</p>

<h2 id="timeouts">Timeouts</h2>

<p>LibFuzzer itself reports timeouts, stored on disk alongside findings as “timeout-&lt;sha1&gt;”. Timeouts 
are defined with a default value of 1200 seconds (20 minutes), though this can be tweaked when calling Jazzer and 
passing <code class="language-plaintext highlighter-rouge">-timeout=120</code> to libFuzzer. Unfortunately, timeouts are terminal and may kill a fuzzing run if 
encountered. This may be desirable for some folks, but we’ve often found the need to gracefully handle timeouts 
ourselves in the context of a larger applications and extended fuzzing runs.</p>

<p>There are a couple options in this scenario. LibFuzzer has a few experimental settings you may configure when calling 
Jazzer. In particular, <a href="https://llvm.org/docs/LibFuzzer.html#fork-mode">fork mode</a> allows you to spin up parallel 
processes for fuzzing, with the side effect of crash resistance. By default, timeouts are ignored, but this can be 
configured with <code class="language-plaintext highlighter-rouge">-ignore_timeouts</code> flag. So a run might look like this:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">--cp</span><span class="o">=</span>jazzer_standalone.jar:target.jar:hook.jar <span class="se">\</span>
com.code_intelligence.jazzer.Jazzer <span class="se">\</span>
<span class="nt">-fork</span><span class="o">=</span>4 <span class="se">\</span>
<span class="nt">--target_class</span><span class="o">=</span>sn.securityresearch.fuzzing.target.ExampleApp <span class="se">\</span>
<span class="nt">--custom_hooks</span><span class="o">=</span>sn.securityresearch.fuzzing.hooks.ExampleHook
</code></pre></div></div>

<p>Alternatively, it’s possible to detect and handle timeouts yourself within the context of the fuzz target. This is 
tricky and not typically going to be necessary outside niche use cases. We can utilize the standard Java <code class="language-plaintext highlighter-rouge">Future</code> API to 
detect and throw our own Jazzer security findings for timeouts. In the example below, our <code class="language-plaintext highlighter-rouge">fuzzerTestOneInput</code> method 
merely serves as a wrapper to pass off our fuzzer input to a separate worker, <code class="language-plaintext highlighter-rouge">ExampleApplicationWorker</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleApp</span><span class="o">{</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">fuzzerTestOneInput</span><span class="o">(</span><span class="nc">FuzzedDataProvider</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">consumeString</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>

        <span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newSingleThreadExecutor</span><span class="o">();</span>
        <span class="nc">Future</span> <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="nc">ExampleApplicationWorker</span><span class="o">(</span><span class="n">c</span><span class="o">));</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TimeoutException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">future</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">FuzzerSecurityIssueCritical</span><span class="o">(</span><span class="s">"Potential Timeout"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">executor</span><span class="o">.</span><span class="na">shutdownNow</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The standard <code class="language-plaintext highlighter-rouge">fuzzerTestOneInput</code> method takes in a string from the fuzzer itself, and passes it to a separate 
thread, <code class="language-plaintext highlighter-rouge">ExampleApplicationWorker</code>. The worker thread is monitored to ensure it finishes in 30 seconds, or the 
thread is terminated and a finding thrown.</p>

<p>Within <code class="language-plaintext highlighter-rouge">ExampleApplicationWorker</code>, we place the functionality that resides in a typical fuzz target.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleApplicationWorker</span> <span class="kd">implements</span> <span class="nc">Runnable</span><span class="o">{</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">input</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ExampleApplicationWorker</span><span class="o">(</span><span class="nc">String</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">input</span> <span class="o">=</span> <span class="n">input</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Do Something....</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Jazzer continues to functional normally, method hooks included, and we can handle timeouts how we wish, though that
might mean more logging or cleaning up application resources in true timeout scenarios.</p>

<h2 id="advanced-run-options">Advanced Run Options</h2>

<p>Both Jazzer itself and libFuzzer contain even more options useful for customizing your fuzzing runs. We’ve included 
a few we found particularly useful.</p>

<h3 id="disable-existing-hooks">Disable Existing Hooks</h3>

<p>As we mentioned earlier, fuzzing becomes particularly useful in the context of your own application and detecting 
vulnerable states, which means working with your own custom method hooks. Jazzer, by default, comes with several 
existing method hooks it will run with by default. You may find these useful; you may not. If you’re looking to 
optimize your fuzzing run and hone in on your own findings, you can disable these existing method hooks with the 
<code class="language-plaintext highlighter-rouge">--disabled_hooks</code> flag. In particular, we found the <code class="language-plaintext highlighter-rouge">RegexInjection</code> and <code class="language-plaintext highlighter-rouge">SqlInjection</code> method hooks to 
be troublesome for our use cases and application, resulting in false positives or unnecessarily consuming fuzzing 
resources.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">--cp</span><span class="o">=</span>jazzer_standalone.jar:target.jar:hook.jar <span class="se">\</span>
com.code_intelligence.jazzer.Jazzer <span class="se">\</span>
<span class="nt">--target_class</span><span class="o">=</span>sn.securityresearch.fuzzing.target.ExampleApp <span class="se">\</span>
<span class="nt">--custom_hooks</span><span class="o">=</span>sn.securityresearch.fuzzing.hooks.ExampleHook <span class="se">\</span>
<span class="nt">--disabled_hooks</span><span class="o">=</span>com.code_intelligence.jazzer.sanitizers.RegexInjection:com.code_intelligence.jazzer.sanitizers.SqlInjection
</code></pre></div></div>

<p>You can see some of the other method hooks <a href="https://github.com/CodeIntelligenceTesting/jazzer/tree/main/sanitizers/src/main/java/com/code_intelligence/jazzer/sanitizers">here</a>.</p>

<h3 id="instrumentation-includes">Instrumentation Includes</h3>

<p>To hone in on your own application, or even better, specific focus areas of your own application, you may find it 
useful to limit instrumentation using the <code class="language-plaintext highlighter-rouge">--instrumentation_includes</code> flag. If you have a large enterprise Java 
application, you really don’t want or need Jazzer instrumenting your entire codebase, including potentially hundreds 
of dependencies.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">--cp</span><span class="o">=</span>jazzer_standalone.jar:target.jar:hook.jar <span class="se">\</span>
com.code_intelligence.jazzer.Jazzer <span class="se">\</span>
<span class="nt">--target_class</span><span class="o">=</span>sn.securityresearch.fuzzing.target.ExampleApp <span class="se">\</span>
<span class="nt">--custom_hooks</span><span class="o">=</span>sn.securityresearch.fuzzing.hooks.ExampleHook <span class="se">\</span>
<span class="nt">--disabled_hooks</span><span class="o">=</span>com.code_intelligence.jazzer.sanitizers.RegexInjection:com.code_intelligence.jazzer.sanitizers.SqlInjection <span class="se">\</span>
<span class="nt">--instrumentation_includes</span><span class="o">=</span>sn.securityresearch.<span class="k">**</span>:com.snc.<span class="k">**</span>
</code></pre></div></div>

<h3 id="keep-going">Keep Going</h3>

<p>If you’re going through the work of creating a fairly complicated fuzzing target and method hook, you’re probably 
not going to want to stop fuzzing runs after a single crash/finding. We’d recommend running Jazzer with the 
<code class="language-plaintext highlighter-rouge">--keep_going</code> flag. Jazzer is more than capable enough to not report duplicate crashes, assuming the stack traces 
match.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">--cp</span><span class="o">=</span>jazzer_standalone.jar:target.jar:hook.jar <span class="se">\</span>
com.code_intelligence.jazzer.Jazzer <span class="se">\</span>
<span class="nt">--target_class</span><span class="o">=</span>sn.securityresearch.fuzzing.target.ExampleApp <span class="se">\</span>
<span class="nt">--custom_hooks</span><span class="o">=</span>sn.securityresearch.fuzzing.hooks.ExampleHook <span class="se">\</span>
<span class="nt">--disabled_hooks</span><span class="o">=</span>com.code_intelligence.jazzer.sanitizers.RegexInjection:com.code_intelligence.jazzer.sanitizers.SqlInjection <span class="se">\</span>
<span class="nt">--instrumentation_includes</span><span class="o">=</span>sn.securityresearch.<span class="k">**</span>:com.snc.<span class="k">**</span> <span class="se">\</span>
<span class="nt">--keep_going</span><span class="o">=</span>10
</code></pre></div></div>

<h2 id="final-thoughts">Final Thoughts</h2>

<p>We hope this post will save at least a few folks some time and improve their fuzzing performance with Jazzer going 
forward. If you take anything from this post, it’s that running out of the box Jazzer with the default 
configurations may not be the best to fuzz sizable Java applications for meaningful vulnerabilities. However, by 
considering the specific application state that indicates a potential vulnerability and using the techniques 
outlined here, you can use Jazzer to more effectively identify actionable security issues.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>https://github.com/CodeIntelligenceTesting/jazzer <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

        
      </section>

      <footer class="page__meta">
        
        
      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <style>
  .page__footer {
    background-color: rgb(255, 255, 255);
    font-family: GilroyRegular, -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
  }

  div#footer {
    border-top: 1px solid #bfbfbf;
    margin-top: 0px;
  }

  .footer__inner-wrap {
    box-sizing: border-box;
    clear: both;
    color: rgb(0, 0, 0);
    display: flex;
    font-family: -apple-system, "system-ui", Roboto, "Segoe UI", "Helvetica Neue", "Lucida Grande", Arial, sans-serif;
    font-size: 1rem;
    height: 137.328px;
    justify-content: space-between;
    line-height: 1.2rem;
    margin-left: 0px;
    margin-right: 0px;
    max-width: 100%;
    padding-bottom: 20px;
    /*padding-left: 20px;
    padding-right: 20px;*/
    padding-top: 20px;
    text-size-adjust: 100%;
  }

  .col-12 {
    box-sizing: border-box;
    color: rgb(0, 0, 0);
    display: block;
    flex-basis: 100%;
    flex-grow: 0;
    flex-shrink: 0;
    float: none;
    font-family: GilroyRegular, -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    font-feature-settings: normal;
    font-kerning: auto;
    font-optical-sizing: auto;
    font-size: 0.5rem;
    font-stretch: 100%;
    font-style: normal;
    font-variant-alternates: normal;
    font-variant-caps: normal;
    font-variant-east-asian: normal;
    font-variant-ligatures: normal;
    font-variant-numeric: normal;
    font-variation-settings: normal;
    font-weight: 400;
    /* height: 864px; */
    letter-spacing: normal;
    line-height: 15px;
    margin-bottom: 0px;
    margin-left: 0px;
    margin-right: 0px;
    margin-top: 0px;
    max-width: 1700px;
    min-height: 1px;
    padding-bottom: 0px;
    padding-left: 40px;
    padding-right: 40px;
    padding-top: 0px;
    position: relative;
    text-align: left;
    text-size-adjust: 100%;
    /* width: 1293px; */
    -webkit-box-flex: 0;
    -webkit-font-smoothing: antialiased;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  }

  .row {
    color: rgb(0, 0, 0);
  }

  .logo-tagline-container {
    padding-left: 0;
    padding-right: 0;
    margin-left: 0px;
    margin-top: 0px;
    /*margin-bottom: 12px;*/
    line-height: 1.5;
    display: inline-block;
    text-align: center;
    color: rgb(0, 0, 0);
    font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;
    font-weight: bold;
    font-feature-settings: normal;
    font-kerning: auto;
    font-optical-sizing: auto;
    font-size: 0.8rem;
    font-stretch: 100%;
    font-style: normal;
    font-variant-alternates: normal;
    font-variant-caps: normal;
    font-variant-east-asian: normal;
    font-variant-ligatures: normal;
    font-variant-numeric: normal;
    font-variation-settings: normal;
    font-weight: 500;
  }

  @media screen and (width < 725px) {
    .logo-tagline-container {
      margin-left: auto;
      margin-right: auto;
      display: block;
    }
  }
  .logo-tagline-container img {
    height: 1.2rem;
    /*min-width: 8rem;*/
    /*width: 118px;*/
    padding-bottom: 8px;
    margin-bottom: 0px;
    /*margin-right: -1rem;
    margin-left: -1rem;*/
  }

  .logo_site_title {
    border-left: 1px solid var(--brand-gray);
    font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;
    font-weight: bold;
    margin-left: 3px;
    padding-left: 10px;
    padding-right: 4px;
  }

  .logo_site_tagline {
    background-color: var(--brand-infinite-blue);
    color: var(--brand-wasabi-green);
    border-left: 1px solid var(--brand-gray);
    font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;
    font-weight: normal;
    font-size: 0.8rem;
    margin-left: 10x;
    padding-left: 10px;
  }

  /*no idea what this was intended for*/
  /*links {
    border: 1px solid #e1e1e1;
    border-left: unset;
    border-right: unset;
    margin: 33px -15px 40px;
    padding: 40px 0 0;
  }*/

  ul.footer-visible-links {
    margin-bottom: 20px;
    margin-top: 0;
    padding-left: 0;
    flex: 0 0 100%;
    max-width: 100%;
  }

  .footer__menu-item-link {
    clear: unset;
    float: unset;
    margin-right: 24px;
  }

  .page__footer-nav {
    font-size: 0.6rem;
    font-family: GilroyRegular, "Century Gothic", CenturyGothic, Arial, Helvetica, sans-serif;
    font-weight: regular;

  }

  .page__footer-copyright {
    font-size: 0.6rem;
  }

  .footer-visible-links {
    display: flex;
    text-align: left;
    font-size: 0.6rem;
    align-items: left;
    -webkit-box-pack: end;
    -ms-flex-pack: end;
    /*justify-content: left;*/
    -webkit-box-flex: 1;
    -ms-flex: 1;
    /*flex: 1;*/
    overflow: hidden;
  }

  .footer__menu-item a {
    display: block;
    list-style-type: none;
    white-space: nowrap;
    font-size: 0.6rem;
    margin-top: 0px;
    margin-left: 0px;
    /*margin-bottom: 20px;*/
  }
</style>


<div id="footer-container">
  <div class="footer__inner-wrap">
    <div class="masthead__menu">
      <div class="logo-tagline-container">
        
        <img src="/assets/images/servicenow-header-logo.svg" alt="Security Lab">
        
        <span class="logo_site_title">Security Lab</span>
        <span class="logo_site_tagline">Keeping your workflows secure.</span>
      </div>
      <nav id="footer-site-nav" class="page__footer-nav">
        <ul class="footer-visible-links"><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="https://www.servicenow.com/terms-of-use.html"  target="_blank">Terms and conditions</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="https://www.servicenow.com/company/trust/privacy/gdpr.html"  target="_blank">GDPR</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="https://www.servicenow.com/privacy-statement.html"  target="_blank">Privacy statement</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="/data-collection"  target="_blank">Data collection</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="mailto:securitylab@servicenow.com?subject=Security%20Lab%20Site%20Contact"  target="_blank">Contact Us</a>
          </li><li class="footer__menu-item">
            <a class="footer__menu-item-link" href="https://twitter.com/SNSecurityLab"  target="_blank">Twitter</a>
          </li></ul>
      </nav>
      <div class="page__footer-copyright">&copy; 2024 ServiceNow, Inc. All
        rights reserved.</div>
    </div>
  </div>
</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
