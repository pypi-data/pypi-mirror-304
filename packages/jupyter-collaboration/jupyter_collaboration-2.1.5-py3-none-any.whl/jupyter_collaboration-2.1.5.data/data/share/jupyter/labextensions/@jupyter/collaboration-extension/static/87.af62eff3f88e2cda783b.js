"use strict";(self.webpackChunk_jupyter_collaboration_extension=self.webpackChunk_jupyter_collaboration_extension||[]).push([[87],{2019:(e,t,o)=>{o.d(t,{y:()=>n});var a=o(3205),s=o(6834);const r=Array.from;Array.isArray;class n{constructor(){this._observers=a.Ue()}on(e,t){a.Yu(this._observers,e,s.Ue).add(t)}once(e,t){const o=(...a)=>{this.off(e,o),t(...a)};this.on(e,o)}off(e,t){const o=this._observers.get(e);void 0!==o&&(o.delete(t),0===o.size&&this._observers.delete(e))}emit(e,t){return r((this._observers.get(e)||a.Ue()).values()).forEach((e=>e(...t)))}destroy(){this._observers=a.Ue()}}},6834:(e,t,o)=>{o.d(t,{Ue:()=>a});const a=()=>new Set},870:(e,t,o)=>{o.d(t,{ZG:()=>a});const a=Date.now},6493:(e,t,o)=>{o.d(t,{Ag:()=>d,GL:()=>c,oy:()=>h,xq:()=>u});var a=o(9476),s=o(2256),r=o(870),n=o(1332),i=o(2019),l=o(1872);o(981);class c extends i.y{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval((()=>{const e=r.ZG();null!==this.getLocalState()&&15e3<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const t=[];this.meta.forEach(((o,a)=>{a!==this.clientID&&3e4<=e-o.lastUpdated&&this.states.has(a)&&t.push(a)})),t.length>0&&d(this,t,"timeout")}),n.GW(3e3)),e.on("destroy",(()=>{this.destroy()})),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const t=this.clientID,o=this.meta.get(t),a=void 0===o?0:o.clock+1,s=this.states.get(t);null===e?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:a,lastUpdated:r.ZG()});const n=[],i=[],c=[],d=[];null===e?d.push(t):null==s?null!=e&&n.push(t):(i.push(t),l.Hi(s,e)||c.push(t)),(n.length>0||c.length>0||d.length>0)&&this.emit("change",[{added:n,updated:c,removed:d},"local"]),this.emit("update",[{added:n,updated:i,removed:d},"local"])}setLocalStateField(e,t){const o=this.getLocalState();null!==o&&this.setLocalState({...o,[e]:t})}getStates(){return this.states}}const d=(e,t,o)=>{const a=[];for(let o=0;o<t.length;o++){const s=t[o];if(e.states.has(s)){if(e.states.delete(s),s===e.clientID){const t=e.meta.get(s);e.meta.set(s,{clock:t.clock+1,lastUpdated:r.ZG()})}a.push(s)}}a.length>0&&(e.emit("change",[{added:[],updated:[],removed:a},o]),e.emit("update",[{added:[],updated:[],removed:a},o]))},u=(e,t,o=e.states)=>{const s=t.length,r=a.Mf();a.uE(r,s);for(let n=0;n<s;n++){const s=t[n],i=o.get(s)||null,l=e.meta.get(s).clock;a.uE(r,s),a.uE(r,l),a.uw(r,JSON.stringify(i))}return a._f(r)},h=(e,t,o)=>{const a=s.l1(t),n=r.ZG(),i=[],c=[],d=[],u=[],h=s.yg(a);for(let t=0;t<h;t++){const t=s.yg(a);let o=s.yg(a);const r=JSON.parse(s.kf(a)),h=e.meta.get(t),p=e.states.get(t),g=void 0===h?0:h.clock;(g<o||g===o&&null===r&&e.states.has(t))&&(null===r?t===e.clientID&&null!=e.getLocalState()?o++:e.states.delete(t):e.states.set(t,r),e.meta.set(t,{clock:o,lastUpdated:n}),void 0===h&&null!==r?i.push(t):void 0!==h&&null===r?u.push(t):null!==r&&(l.Hi(r,p)||d.push(t),c.push(t)))}(i.length>0||d.length>0||u.length>0)&&e.emit("change",[{added:i,updated:d,removed:u},o]),(i.length>0||c.length>0||u.length>0)&&e.emit("update",[{added:i,updated:c,removed:u},o])}},5087:(e,t,o)=>{o.r(t),o.d(t,{default:()=>E});var a,s=o(8916),r=o(4083),n=o(5814),i=o(5380),l=o(4889),c=o(8658),d=o(9448),u=o(6794),h=o(2733),p=o(3075);!function(e){e.openPath="filebrowser:open-path"}(a||(a={}));const g={id:"@jupyter/collaboration-extension:drive",description:"The default collaborative drive provider",provides:p.ICollaborativeDrive,requires:[u.ITranslator],optional:[],activate:(e,t)=>{const o=t.load("jupyter_collaboration"),a=new p.YDrive(e.serviceManager.user,o);return e.serviceManager.contents.addDrive(a),a}},v={id:"@jupyter/collaboration-extension:yfile",description:"Plugin to register the shared model factory for the content type 'file'",autoStart:!0,requires:[p.ICollaborativeDrive],optional:[],activate:(e,t)=>{t.sharedModelFactory.registerDocumentFactory("file",(()=>new h.YFile))}},m={id:"@jupyter/collaboration-extension:ynotebook",description:"Plugin to register the shared model factory for the content type 'notebook'",autoStart:!0,requires:[p.ICollaborativeDrive],optional:[d.ISettingRegistry],activate:(e,t,o)=>{let a=!0;o&&o.load("@jupyterlab/notebook-extension:tracker").then((e=>{const t=e=>{var t;const o=null==e?void 0:e.get("experimentalEnableDocumentWideUndoRedo").composite;a=null===(t=!o)||void 0===t||t};t(e),e.changed.connect((e=>t(e)))})),t.sharedModelFactory.registerDocumentFactory("notebook",(()=>new h.YNotebook({disableDocumentWideUndoRedo:a})))}},y={id:"@jupyter/collaboration-extension:defaultFileBrowser",description:"The default file browser factory provider",provides:n.IDefaultFileBrowser,requires:[p.ICollaborativeDrive,n.IFileBrowserFactory],optional:[s.IRouter,s.JupyterFrontEnd.ITreeResolver,s.ILabShell,d.ISettingRegistry],activate:async(e,t,o,a,s,r)=>{const{commands:n}=e;e.serviceManager.contents.addDrive(t);const i=o.createFileBrowser("filebrowser",{auto:!1,restore:!1,driveName:t.name});return w.restoreBrowser(i,n,a,s,r),i}},b={id:"@jupyter/collaboration-extension:logger",description:"A logging plugin for debugging purposes.",autoStart:!0,optional:[l.ILoggerRegistry,i.IEditorTracker,c.INotebookTracker,u.ITranslator],activate:(e,t,o,a,s)=>{const n=(null!=s?s:u.nullTranslator).load("jupyter_collaboration"),i="https://schema.jupyter.org/jupyter_collaboration/session/v1";if(!t)return void e.serviceManager.events.stream.connect(((e,t)=>{var o,a;t.schema_id===i&&(console.debug(`[${t.room}(${t.path})] ${null!==(o=t.action)&&void 0!==o?o:""}: ${null!==(a=t.msg)&&void 0!==a?a:""}`),"WARNING"===t.level&&(0,r.showDialog)({title:n.__("Warning"),body:n.__(`Two collaborative sessions are accessing the file ${t.path} simultaneously.\n                \nOpening the same file using different views simultaneously is not supported. Please, close one view; otherwise, you might lose some of your progress.`),buttons:[r.Dialog.okButton()]}))}));const l=new Map,c=(e,o)=>{const a=t.getLogger(o.context.path);l.set(o.context.localPath,a),o.disposed.connect((e=>{l.delete(e.context.localPath)}))};o&&o.widgetAdded.connect(c),a&&a.widgetAdded.connect(c),(async()=>{var t,o;const{events:a}=e.serviceManager;for await(const e of a.stream)if(e.schema_id===i){const a=l.get(e.path);null==a||a.log({type:"text",level:e.level.toLowerCase(),data:`[${e.room}] ${null!==(t=e.action)&&void 0!==t?t:""}: ${null!==(o=e.msg)&&void 0!==o?o:""}`}),"WARNING"===e.level&&(0,r.showDialog)({title:n.__("Warning"),body:n.__("Two collaborative sessions are accessing the file %1 simultaneously.\n                \nOpening a document with multiple views simultaneously is not supported. Please close one view; otherwise, you might lose some of your progress.",e.path),buttons:[r.Dialog.warnButton({label:n.__("Ok")})]})}})()}};var w;!function(e){e.restoreBrowser=async function(e,t,o,s,r){const n="jp-mod-restoring";if(e.addClass(n),!o)return await e.model.restore(e.id),await e.model.refresh(),void e.removeClass(n);const i=async()=>{o.routed.disconnect(i);const l=await(null==s?void 0:s.paths);(null==l?void 0:l.file)||(null==l?void 0:l.browser)?(await e.model.restore(e.id,!1),l.file&&await t.execute(a.openPath,{path:l.file,dontShowBrowser:!0}),l.browser&&await t.execute(a.openPath,{path:l.browser,dontShowBrowser:!0})):(await e.model.restore(e.id),await e.model.refresh()),e.removeClass(n),(null==r?void 0:r.isEmpty("main"))&&t.execute("launcher:create")};o.routed.connect(i)}}(w||(w={}));var f=o(6893),I=o(444),_=o(8492),S=o(1182),k=o(7954),x=o(4882),D=o(8078),j=o(981),M=o(6493);const C={id:"@jupyter/collaboration-extension:userMenu",description:"Provide connected user menu.",requires:[],provides:D.IUserMenu,activate:e=>{const{commands:t}=e,{user:o}=e.serviceManager;return new D.UserMenu({commands:t,user:o})}},L={id:"@jupyter/collaboration-extension:user-menu-bar",description:"Add user menu to the interface.",autoStart:!0,requires:[D.IUserMenu,r.IToolbarWidgetRegistry],activate:async(e,t,o)=>{const{user:a}=e.serviceManager,s=new x.MenuBar({forceItemsPosition:{forceX:!1,forceY:!1},renderer:new D.RendererUserMenu(a)});s.id="jp-UserMenu",a.userChanged.connect((()=>s.update())),s.addMenu(t),o.addFactory("TopBar","user-menu",(()=>s))}},U={id:"@jupyter/collaboration-extension:rtcGlobalAwareness",description:"Add global awareness to share working document of users.",requires:[k.IStateDB],provides:D.IGlobalAwareness,activate:(e,t)=>{const{user:o}=e.serviceManager,a=new j.Doc,s=new M.GL(a),r=S.ServerConnection.makeSettings(),n=_.URLExt.join(r.wsUrl,"api/collaboration/room");return new p.WebSocketAwarenessProvider({url:n,roomID:"JupyterLab:globalAwareness",awareness:s,user:o}),t.changed.connect((async()=>{var e,o;const a=(null===(o=null===(e=(await t.toJSON())["layout-restorer:data"])||void 0===e?void 0:e.main)||void 0===o?void 0:o.current)||"";a.startsWith("editor")||a.startsWith("notebook")?s.setLocalStateField("current",a):s.setLocalStateField("current",null)})),s}},A={id:"@jupyter/collaboration-extension:rtcPanel",description:"Add side panel to display all currently connected users.",autoStart:!0,requires:[D.IGlobalAwareness],optional:[u.ITranslator],activate:(e,t,o)=>{const{user:a}=e.serviceManager,s=(null!=o?o:u.nullTranslator).load("jupyter_collaboration"),r=new I.SidePanel({alignment:"justify"});r.id="jp-collaboration-panel",r.title.icon=I.usersIcon,r.title.caption=s.__("Collaboration"),r.addClass("jp-RTCPanel"),e.shell.add(r,"left",{rank:300});const n=new D.UserInfoPanel(a);n.title.label=s.__("User info"),n.title.caption=s.__("User information"),r.addWidget(n);const i=new D.CollaboratorsPanel(a,t,(t=>{e.commands.execute("docmanager:open",{path:t})}));i.title.label=s.__("Online Collaborators"),r.addWidget(i)}},P={id:"@jupyter/collaboration-extension:userEditorCursors",description:"Add CodeMirror extension to display remote user cursors and selections.",autoStart:!0,requires:[f.IEditorExtensionRegistry],activate:(e,t)=>{t.addExtension({name:"remote-user-cursors",factory(e){const{awareness:t,ysource:o}=e.model.sharedModel;return f.EditorExtensionRegistry.createImmutableExtension((0,D.remoteUserCursors)({awareness:t,ytext:o}))}})}};var T;!function(e){e.share="collaboration:shared-link"}(T||(T={}));const E=[g,v,m,y,b,C,L,U,A,{id:"@jupyter/collaboration-extension:shared-link",autoStart:!0,optional:[r.ICommandPalette,u.ITranslator],activate:async(e,t,o)=>{const{commands:a}=e,s=(null!=o?o:u.nullTranslator).load("collaboration");a.addCommand(T.share,{label:s.__("Generate a Shared Link"),icon:I.shareIcon,execute:async()=>{const e=await(0,D.showSharedLinkDialog)({translator:o});e.button.accept&&e.value&&r.Clipboard.copyToSystem(e.value)}}),t&&t.addItem({command:T.share,category:s.__("Server")})}},P]}}]);