(function(x,s){typeof exports=="object"&&typeof module<"u"?s(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],s):(x=typeof globalThis<"u"?globalThis:x||self,s(x.trame_annotations={},x.Vue))})(this,function(x,s){"use strict";class C{constructor(e,n=0){this.bounds={x:e.x||0,y:e.y||0,width:e.width,height:e.height},this.maxObjects=typeof e.maxObjects=="number"?e.maxObjects:10,this.maxLevels=typeof e.maxLevels=="number"?e.maxLevels:4,this.level=n,this.objects=[],this.nodes=[]}getIndex(e){return e.qtIndex(this.bounds)}split(){const e=this.level+1,n=this.bounds.width/2,i=this.bounds.height/2,o=this.bounds.x,u=this.bounds.y,c=[{x:o+n,y:u},{x:o,y:u},{x:o,y:u+i},{x:o+n,y:u+i}];for(let a=0;a<4;a++)this.nodes[a]=new C({x:c[a].x,y:c[a].y,width:n,height:i,maxObjects:this.maxObjects,maxLevels:this.maxLevels},e)}insert(e){if(this.nodes.length){const n=this.getIndex(e);for(let i=0;i<n.length;i++)this.nodes[n[i]].insert(e);return}if(this.objects.push(e),this.objects.length>this.maxObjects&&this.level<this.maxLevels){this.nodes.length||this.split();for(let n=0;n<this.objects.length;n++){const i=this.getIndex(this.objects[n]);for(let o=0;o<i.length;o++)this.nodes[i[o]].insert(this.objects[n])}this.objects=[]}}retrieve(e){const n=this.getIndex(e);let i=this.objects;if(this.nodes.length)for(let o=0;o<n.length;o++)i=i.concat(this.nodes[n[o]].retrieve(e));return this.level===0?Array.from(new Set(i)):i}remove(e,n=!1){const i=this.objects.indexOf(e);i>-1&&this.objects.splice(i,1);for(let o=0;o<this.nodes.length;o++)this.nodes[o].remove(e);return this.level===0&&!n&&this.join(),i!==-1}update(e,n=!1){this.remove(e,n),this.insert(e)}join(){let e=Array.from(this.objects);for(let i=0;i<this.nodes.length;i++){const o=this.nodes[i].join();e=e.concat(o)}const n=Array.from(new Set(e));if(n.length<=this.maxObjects){this.objects=n;for(let i=0;i<this.nodes.length;i++)this.nodes[i].objects=[];this.nodes=[]}return e}clear(){this.objects=[];for(let e=0;e<this.nodes.length;e++)this.nodes.length&&this.nodes[e].clear();this.nodes=[]}}class k{constructor(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this.data=e.data}qtIndex(e){const n=[],i=e.x+e.width/2,o=e.y+e.height/2,u=this.y<o,c=this.x<i,a=this.x+this.width>i,m=this.y+this.height>o;return u&&a&&n.push(0),c&&u&&n.push(1),c&&m&&n.push(2),a&&m&&n.push(3),n}}const B={style:{position:"relative"}},F=["src"],L=12,T={ImageDetection:s.defineComponent({__name:"ImageDetection",props:{identifier:{},src:{},annotations:{},categories:{},selected:{type:Boolean},containerSelector:{}},emits:["hover"],setup(p,{emit:e}){const n=[[255,0,0],[0,255,0],[0,0,255],[255,255,0],[255,0,255],[0,255,255]],i=[8,8];let o;function u(t,l){return l.x>=t.x+t.width||t.x>=l.x+l.width?!1:!(l.y>=t.y+t.height||t.y>=l.y+l.height)}const c=p,a=s.ref(),m=s.computed(()=>{var t;return(t=a.value)==null?void 0:t.getContext("2d",{alpha:!0})}),g=s.ref(),_=s.computed(()=>{var t;return(t=g.value)==null?void 0:t.getContext("2d",{willReadFrequently:!0})}),d=s.ref(),b=s.ref({width:0,height:0}),I=s.ref(),A=()=>{var t,l;b.value={width:((t=I.value)==null?void 0:t.naturalWidth)??0,height:((l=I.value)==null?void 0:l.naturalHeight)??0}},V=s.computed(()=>s.unref(c.annotations)??[]),M=s.computed(()=>V.value.map(t=>{const l=t.category_id??0,h=n[l%n.length];return{...t,color:h}}));s.watchEffect(()=>{if(!a.value||!m.value)return;const t=a.value,l=m.value;t.width=b.value.width,t.height=b.value.height,l.clearRect(0,0,t.width,t.height);const h=.5;M.value.forEach(({color:r,bbox:f})=>{l.fillStyle=`rgba(${[...r,h].join(",")})`,l.fillRect(f[0],f[1],f[2],f[3])})}),s.watchEffect(()=>{if(!_.value||!g.value)return;const t=g.value,l=_.value;t.width=b.value.width,t.height=b.value.height,l.clearRect(0,0,t.width,t.height),o=new C({width:t.width,height:t.height,maxLevels:8,maxObjects:10}),V.value.forEach((h,r)=>{const f=new k({x:h.bbox[0],y:h.bbox[1],width:h.bbox[2],height:h.bbox[3],data:r});o==null||o.insert(f),l.fillStyle="rgb(255, 0, 0)",l.fillRect(h.bbox[0],h.bbox[1],h.bbox[2],h.bbox[3])})});const N=e;function Y(){d.value&&(d.value.style.visibility="hidden")}s.onMounted(Y);function J(){N("hover",{id:c.identifier})}function K(){N("hover",{id:""}),Y()}function Q(t,l,h){const r=h.getBoundingClientRect(),f=h.width*(t-r.left)/r.width,q=h.height*(l-r.top)/r.height;return[f,q]}const $=s.ref(!1);s.onMounted(()=>{$.value=!0});const U=s.computed(()=>!$.value||!c.containerSelector?null:document.querySelector(c.containerSelector));function Z(t){var W;if(!g.value||g.value.width===0||!d.value||!o||!c.categories||!c.annotations)return;const l=_.value;if(!l)return;const[h,r]=Q(t.clientX,t.clientY,g.value);if(!(l.getImageData(h,r,1,1).data[0]>0)){d.value.style.visibility="hidden";return}d.value.style.visibility="visible";const X=new k({x:h,y:r,width:2,height:2}),ie=o.retrieve(X).filter(v=>u(v,X)).filter(v=>v.data!=null).map(v=>{var H;const y=M.value[v.data],ne=((H=c.categories[y.category_id])==null?void 0:H.name)??y.label,se=y.color,E=document.createElement("li");E.style.textShadow=`rgba(${se.join(",")},0.6) 1px 1px 3px`;const oe=y.id?` : ${y.id}`:"";return E.textContent=`${ne}${oe}`,E});d.value.replaceChildren(...ie);const[z,D]=[t.offsetX,t.offsetY];let S=z+i[0],R=D+i[1];const w=d.value.getBoundingClientRect(),P=g.value.getBoundingClientRect(),j=((W=U.value)==null?void 0:W.getBoundingClientRect())??{left:0,top:0,width:window.innerWidth,height:window.innerHeight},O={left:P.left+S-j.left,top:P.top+R-j.top,width:w.width+L,height:w.height+L};O.left+O.width>j.width&&(S=z-w.width-i[0]),O.top+O.height>j.height&&(R=D-w.height-i[1]),d.value.style.left=`${S}px`,d.value.style.top=`${R}px`}const ee=s.computed(()=>c.selected?"4":"0"),te=s.computed(()=>s.unref(c.src));return(t,l)=>(s.openBlock(),s.createElementBlock("div",B,[s.createElementVNode("img",{ref_key:"img",ref:I,src:te.value,style:s.normalizeStyle([{outlineWidth:ee.value+"px"},{width:"100%","outline-style":"dotted","outline-color":"red"}]),onLoad:A},null,44,F),s.createElementVNode("canvas",{ref_key:"visibleCanvas",ref:a,style:{width:"100%",position:"absolute",left:"0",top:"0"}},null,512),s.createElementVNode("canvas",{ref_key:"pickingCanvas",ref:g,style:{opacity:"0",width:"100%",position:"absolute",left:"0",top:"0"},onMouseenter:J,onMousemove:Z,onMouseleave:K},null,544),s.createElementVNode("ul",{ref_key:"labelContainer",ref:d,style:{position:"absolute","z-index":"10",padding:"0.4rem","white-space":"pre","font-size":"small","border-radius":"0.2rem","border-color":"rgba(127, 127, 127, 0.75)","border-style":"solid","border-width":"thin","background-color":"#efefef","list-style-type":"none"}},null,512)]))}})};function G(p){Object.keys(T).forEach(e=>{p.component(e,T[e])})}x.install=G,Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});
