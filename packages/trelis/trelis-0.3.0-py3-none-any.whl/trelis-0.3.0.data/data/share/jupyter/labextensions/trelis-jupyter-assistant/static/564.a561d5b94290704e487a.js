(self.webpackChunktrelis_jupyter_assistant=self.webpackChunktrelis_jupyter_assistant||[]).push([[564],{564:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>A});var o=n(909),r=n(614),a=n(480),i=n(215),s=n(256);const c=n(606).env.TRELIS_API_URL||"https://jupyter.trelis.com";class l extends s.Widget{constructor(e,t){super(),this.notebookTracker=e,this.addClass("jp-ChatbotWidget"),this.chatContainer=document.createElement("div"),this.inputArea=document.createElement("textarea"),this.rendermime=t,this.initializeWidget(),this.checkStoredApiKey()}initializeWidget(){this.node.style.display="flex",this.node.style.flexDirection="column",this.node.style.height="100%",this.apiKeyContainer=document.createElement("div"),this.apiKeyContainer.className="api-key-container";const e=document.createElement("label");e.textContent="API Key: ",this.apiKeyInput=document.createElement("input"),this.apiKeyInput.type="password",this.apiKeyInput.className="api-key-input";const t=document.createElement("div");t.className="save-key-container";const n=document.createElement("input");n.type="checkbox",n.id="save-key";const o=document.createElement("label");o.htmlFor="save-key",o.textContent="Remember API key";const r=document.createElement("button");r.textContent="Save",r.className="save-button",r.onclick=()=>this.saveApiKey(),t.appendChild(n),t.appendChild(o),t.appendChild(r),this.apiKeyContainer.appendChild(e),this.apiKeyContainer.appendChild(this.apiKeyInput),this.apiKeyContainer.appendChild(t);const a=document.createElement("div");a.className="chat-interface",this.chatContainer=document.createElement("div"),this.chatContainer.className="chat-container";const i=document.createElement("div");i.className="input-container",this.inputArea=document.createElement("textarea"),this.inputArea.rows=3,this.inputArea.className="input-area",this.inputArea.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.handleSend())}));const s=document.createElement("div");s.className="send-button-container";const c=document.createElement("div");c.style.display="flex",c.style.alignItems="center";const l=document.createElement("button");l.textContent="Send",l.className="send-button",l.onclick=()=>this.handleSend();const d=document.createElement("span");d.className="send-button-hint",d.textContent="(or press Enter)";const p=document.createElement("button");p.textContent="New Chat",p.className="new-chat-button",p.onclick=()=>this.startNewChat(),c.appendChild(l),c.appendChild(d),s.appendChild(c),s.appendChild(p),i.appendChild(this.inputArea),i.appendChild(s),a.appendChild(this.chatContainer),a.appendChild(i),this.node.appendChild(this.apiKeyContainer),this.node.appendChild(a)}startNewChat(){this.chatContainer.innerHTML="",this.inputArea.value=""}async addMessage(e,t){const n=document.createElement("div");if(n.className=`chat-message ${e}-message`,"assistant"===e){const e=await this.renderAssistantMessage(t);n.appendChild(e)}else{const e=await this.renderMarkdown(t);n.appendChild(e)}this.chatContainer.appendChild(n),this.chatContainer.scrollTop=this.chatContainer.scrollHeight}async validateApiKey(e){console.log("Attempting to validate API key...");try{const t=`${c}/api/v1/validate-key`;console.log("Sending request to:",t);const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:e})});return console.log("Validation response:",n.status),n.ok?!0===(await n.json()).valid:!1}catch(e){return console.error("Detailed error validating API key:",e),!1}}async handleSend(){const e=this.inputArea.value.trim();if(!e)return void alert("Please enter a message");const t=this.apiKeyInput.value.trim();if(!t)return alert("Please enter an API key first"),void(this.apiKeyContainer.style.display="block");try{const n=this.node.querySelector(".send-button");this.inputArea.disabled=!0,n.disabled=!0,n.textContent="Generating...",await this.addMessage("user",e),this.inputArea.value="";const o=document.createElement("div");o.className="chat-message assistant-message generating-message",o.textContent="Generating response...",this.chatContainer.appendChild(o),this.chatContainer.scrollTop=this.chatContainer.scrollHeight;const r=this.notebookTracker.currentWidget;if(!r||!r.model)return console.warn("No active notebook found"),void await this.addMessage("assistant","Please open a notebook to use this feature.");const a=r.model;try{const n=a.toJSON();if(!n||!n.cells)return console.warn("No cells found in notebook"),void await this.addMessage("assistant","Unable to read notebook cells.");const r=n.cells;console.log("Total cells found:",r.length),r.forEach(((e,t)=>{e.outputs&&(console.log(`Cell ${t} type:`,e.cell_type),console.log(`Cell ${t} outputs:`,JSON.stringify(e.outputs,null,2)))}));const i=r.map((e=>e.outputs&&0!==e.outputs.length?{...e,outputs:e.outputs.map((e=>{var t;if("error"===e.output_type)return{output_type:"error",content:{error_type:e.ename,error_message:e.evalue,traceback:e.traceback}};let n="";return"stream"===e.output_type?n=e.text||"":"execute_result"!==e.output_type&&"display_data"!==e.output_type||(n=(null===(t=e.data)||void 0===t?void 0:t["text/plain"])||JSON.stringify(e.data||{})),{output_type:e.output_type,content:n}})).filter(Boolean)}:e));console.log("Processed cells:",JSON.stringify(i,null,2)),this.setLoadingState(!0);try{const n=await fetch(`${c}/api/v1/chat`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":t},body:JSON.stringify({message:e,notebook_cells:i})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const r=await n.json();console.log("Raw assistant response:",r.response),this.chatContainer.removeChild(o),await this.addMessage("assistant",r.response)}catch(e){console.error("Error:",e),await this.addMessage("assistant","An error occurred while fetching the response.")}finally{this.setLoadingState(!1)}}catch(e){console.error("Error:",e),await this.addMessage("assistant","Sorry, there was an error processing your request. Please try again.")}}catch(e){console.error("Error:",e),await this.addMessage("assistant","Sorry, there was an error processing your request. Please try again.")}finally{this.inputArea.disabled=!1;const e=this.node.querySelector(".send-button");e.disabled=!1,e.textContent="Send"}}async checkStoredApiKey(){console.log("Checking stored API key...");const e=localStorage.getItem("trelis_api_key");e&&(console.log("Found stored key"),this.apiKeyInput.value=e,await this.validateApiKey(e)?this.apiKeyContainer.style.display="none":localStorage.removeItem("trelis_api_key"))}async saveApiKey(){console.log("Save API key triggered");const e=this.apiKeyInput.value.trim(),t=this.node.querySelector("#save-key");e?await this.validateApiKey(e)?((null==t?void 0:t.checked)&&localStorage.setItem("trelis_api_key",e),this.apiKeyContainer.style.display="none"):alert("Invalid API key. Please check and try again."):alert("Please enter an API key")}async renderAssistantMessage(e){const t=document.createElement("div");try{const n=e.replace(/(?<![\n])\n([*-]|\d+\.)\s/g,"\n\n$1 ").replace(/```/g,"\n\n```").replace(/\*\*/g,"**").replace(/([*-]|\d+\.)\s(.*?)(?=\n|$)/g,"$1 $2\n"),o=await this.renderMarkdown(n);t.appendChild(o);const r=t.querySelectorAll("pre code"),a=this.parseCodeSuggestions(e);r.forEach((e=>{var t;const n=e.textContent||"",o=e.parentElement;if(!o)return;const r=document.createElement("div");r.className="code-container",null===(t=o.parentNode)||void 0===t||t.replaceChild(r,o),r.appendChild(o);const i=document.createElement("div");i.className="button-container";const s=a.find((([e,t])=>t.trim()===n.trim()));if(s){const[e,t]=s,o=this.createReplaceButton(e,n);i.appendChild(o)}const c=this.createCopyButton(n);i.appendChild(c),r.appendChild(i)}))}catch(n){console.error("Error rendering markdown:",n),t.textContent=e}return t}createReplaceButton(e,t){const n=document.createElement("button");return n.textContent=`Replace cell ${e}`,n.className="replace-button",n.onclick=()=>this.replaceCode(e,t),n}createCopyButton(e){const t=document.createElement("button");return t.innerHTML='<svg width="16" height="16" fill="currentColor" class="bi bi-files" viewBox="0 0 16 16">\n        <path d="M13 0H3a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM3 1h10a1 1 0 0 1 1 1v1H2V2a1 1 0 0 1 1-1zm10 14H3a1 1 0 0 1-1-1V4h10v10a1 1 0 0 1-1 1z"/>\n    </svg>',t.className="copy-button",t.onclick=()=>{navigator.clipboard.writeText(e).then((()=>{console.log("Code copied to clipboard")}))},t}async renderMarkdown(e){const t="text/markdown",n=new i.MimeModel({data:{[t]:e},metadata:{}}),o=this.rendermime.createRenderer(t);return await o.renderModel(n),o.node}parseCodeSuggestions(e){const t=/```(?:python\s*)?\n([\s\S]+?)\n```/g,n=/(?:in|In) cell (?:\[?(\d+)\]?|(\w+))|Cell (\d+):/i,o=[];let r;for(;null!==(r=t.exec(e));){const t=r[1].trim(),a=e.substring(Math.max(0,r.index-100),r.index).match(n);if(a){const e=parseInt(a[1]||a[2]||a[3]||a[4]);isNaN(e)||o.push([e,t])}}return o}replaceCode(e,t){const n=this.notebookTracker.currentWidget;if(n){const o=n.content.widgets[e-1];o&&"code"===o.model.type&&o.model.sharedModel.setSource(t)}}setLoadingState(e){const t=this.node.querySelector(".input-area"),n=this.node.querySelector(".send-button");e?(t.disabled=!0,n.disabled=!0,n.textContent="Generating..."):(t.disabled=!1,n.disabled=!1,n.textContent="Send")}}var d=n(72),p=n.n(d),u=n(825),h=n.n(u),m=n(659),f=n.n(m),g=n(56),y=n.n(g),b=n(540),v=n.n(b),x=n(113),C=n.n(x),w=n(646),k={};k.styleTagTransform=C(),k.setAttributes=y(),k.insert=f().bind(null,"head"),k.domAPI=h(),k.insertStyleElement=v(),p()(w.A,k),w.A&&w.A.locals&&w.A.locals;const S={id:"trelis-jupyter-assistant:plugin",description:"A JupyterLab Code Assistant",autoStart:!0,requires:[a.INotebookTracker,i.IRenderMimeRegistry],optional:[r.ISettingRegistry,o.ILayoutRestorer],activate:(e,t,n,o,r)=>{console.log("JupyterLab extension trelis-jupyter-assistant is activated!");const a=new l(t,n);a.id="trelis-chatbot",a.title.label="Trelis",a.title.closable=!0,e.shell.add(a,"right",{rank:1e3}),r&&r.add(a,"trelis-chatbot"),o&&o.load(S.id).then((e=>{console.log("trelis-jupyter-assistant settings loaded:",e.composite)})).catch((e=>{console.error("Failed to load settings for trelis-jupyter-assistant.",e)}))}},A=S},475:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(601),r=n.n(o),a=n(314),i=n.n(a)()(r());i.push([e.id,"/*\n    See the JupyterLab Developer Guide for useful CSS Patterns:\n\n    https://jupyterlab.readthedocs.io/en/stable/developer/css.html\n*/\n",""]);const s=i},646:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var o=n(601),r=n.n(o),a=n(314),i=n.n(a),s=n(475),c=i()(r());c.i(s.A),c.push([e.id,'#trelis-chatbot {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  overflow: hidden;\n}\n\n.jp-ChatbotWidget {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  overflow: hidden;\n  padding: 10px;\n}\n\n.chat-interface {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n}\n\n.chat-container {\n  flex-grow: 1;\n  overflow-y: auto;\n  margin-bottom: 20px;\n  padding: 10px;\n}\n\n.chat-message {\n  margin-bottom: 15px;\n  padding: 10px;\n  border-radius: 8px;\n  position: relative; /* For the left border */\n  padding-left: 20px; /* Make room for the left border */\n}\n\n.user-message {\n  border-left: 4px solid #4CAF50; /* Green for user */\n  background-color: #f5f9f5;\n}\n\n.assistant-message {\n  border-left: 4px solid #0f579b; /* Blue for assistant */\n  background-color: #f8f9fa;\n}\n\n/* Remove the "You:" and "Trelis Assistant:" labels from the messages */\n.chat-message strong {\n  display: none;\n}\n\n/* Style for the generating message */\n.generating-message {\n  font-style: italic;\n  color: #666;\n  padding: 10px;\n  margin-bottom: 15px;\n  background-color: #f8f9fa;\n  border-left: 4px solid #0f579b;\n  padding-left: 20px;\n}\n\n.code-container {\n  display: flex;\n  flex-direction: column; /* Stack children vertically */\n  position: relative;\n  margin: 0.5rem 0;\n  padding: 0.25rem;\n  background-color: #f8f8f8;\n  border-radius: 4px;\n}\n\n.code-container pre {\n  padding: 0.25rem;\n  margin: 0;\n  white-space: pre-wrap;\n  word-break: break-all;\n}\n\n.button-container {\n  display: flex;\n  gap: 8px; /* Space between buttons */\n  align-items: center;\n  margin-top: 8px; /* Space between code and buttons */\n}\n\n.replace-button {\n  background-color: #0f579b;\n  color: white;\n  border: none;\n  padding: 5px 10px;\n  cursor: pointer;\n  border-radius: 4px;\n  font-size: 12px;\n}\n\n.input-container {\n  display: flex;\n  flex-direction: column;\n  border-top: 1px solid #ccc;\n  padding-top: 10px;\n  width: 100%;\n  box-sizing: border-box;\n}\n\n.input-area {\n  width: 100%;\n  min-height: 60px;\n  margin-bottom: 10px;\n  resize: vertical;\n  padding: 8px;\n  border-radius: 4px;\n  border: 1px solid #ccc;\n  box-sizing: border-box;\n}\n\n.send-button-container {\n  display: flex;\n  flex-direction: column;\n  gap: 10px; /* Space between buttons */\n}\n\n/* Style for the send button and hint */\n.send-button {\n  background-color: #0f579b;\n  color: white;\n  border: none;\n  padding: 8px 15px;\n  cursor: pointer;\n  border-radius: 4px;\n  width: 100px;\n}\n\n.send-button-hint {\n  font-style: italic;\n  color: #666;\n  margin-left: 10px;\n}\n\n.copy-button {\n  background-color: transparent;\n  border: none;\n  cursor: pointer;\n  display: inline-flex;\n  align-items: center;\n}\n\n.copy-button svg {\n  width: 16px; /* Adjust size as needed */\n  height: 16px; /* Adjust size as needed */\n  fill: #0f579b; /* Match the theme color */\n}\n\n/* Optional: Add hover effect */\n.copy-button:hover {\n  opacity: 0.7; /* Slightly fade on hover */\n}\n\n.api-key-container {\n  padding: 10px;\n  margin-bottom: 10px;\n  border-bottom: 1px solid #ccc;\n}\n\n.api-key-input {\n  margin: 0 10px;\n  padding: 5px;\n  border: 1px solid #ccc;\n  border-radius: 4px;\n  width: 200px;\n}\n\n.save-key-container {\n  margin-top: 5px;\n  display: flex;\n  align-items: center;\n  gap: 10px;\n}\n\n.save-button {\n  background-color: #0f579b;\n  color: white;\n  border: none;\n  padding: 5px 10px;\n  cursor: pointer;\n  border-radius: 4px;\n  font-size: 12px;\n}\n\n.error-message {\n  background-color: #ffebee;\n  border-left: 4px solid #f44336;\n  padding: 10px;\n  margin: 10px 0;\n  font-family: monospace;\n  white-space: pre-wrap;\n}\n\n.send-button:disabled {\n  background-color: #cccccc;\n  cursor: not-allowed;\n}\n\n.input-area:disabled {\n  background-color: #f5f5f5;\n  cursor: not-allowed;\n}\n\n/* Add styles for the button container */\n.action-buttons-container {\n  display: flex;\n  gap: 10px;\n  margin-top: 10px;\n}\n\n/* Style for the New Chat button */\n.new-chat-button {\n  background-color: #4CAF50;\n  color: white;\n  border: none;\n  padding: 8px 15px;\n  cursor: pointer;\n  border-radius: 4px;\n  width: 100px;\n  align-self: flex-start; /* Align with the Send button */\n}\n\n.new-chat-button:hover {\n  background-color: #45a049;\n}\n',""]);const l=c},314:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",o=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),o&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),o&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,o,r,a){"string"==typeof e&&(e=[[null,e,void 0]]);var i={};if(o)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(i[c]=!0)}for(var l=0;l<e.length;l++){var d=[].concat(e[l]);o&&i[d[0]]||(void 0!==a&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=a),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),r&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=r):d[4]="".concat(r)),t.push(d))}},t}},601:e=>{"use strict";e.exports=function(e){return e[1]}},606:e=>{var t,n,o=e.exports={};function r(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function i(e){if(t===setTimeout)return setTimeout(e,0);if((t===r||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:r}catch(e){t=r}try{n="function"==typeof clearTimeout?clearTimeout:a}catch(e){n=a}}();var s,c=[],l=!1,d=-1;function p(){l&&s&&(l=!1,s.length?c=s.concat(c):d=-1,c.length&&u())}function u(){if(!l){var e=i(p);l=!0;for(var t=c.length;t;){for(s=c,c=[];++d<t;)s&&s[d].run();d=-1,t=c.length}s=null,l=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===a||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{return n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function h(e,t){this.fun=e,this.array=t}function m(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new h(e,t)),1!==c.length||l||i(u)},h.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=m,o.addListener=m,o.once=m,o.off=m,o.removeListener=m,o.removeAllListeners=m,o.emit=m,o.prependListener=m,o.prependOnceListener=m,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},72:e=>{"use strict";var t=[];function n(e){for(var n=-1,o=0;o<t.length;o++)if(t[o].identifier===e){n=o;break}return n}function o(e,o){for(var a={},i=[],s=0;s<e.length;s++){var c=e[s],l=o.base?c[0]+o.base:c[0],d=a[l]||0,p="".concat(l," ").concat(d);a[l]=d+1;var u=n(p),h={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==u)t[u].references++,t[u].updater(h);else{var m=r(h,o);o.byIndex=s,t.splice(s,0,{identifier:p,updater:m,references:1})}i.push(p)}return i}function r(e,t){var n=t.domAPI(t);return n.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,r){var a=o(e=e||[],r=r||{});return function(e){e=e||[];for(var i=0;i<a.length;i++){var s=n(a[i]);t[s].references--}for(var c=o(e,r),l=0;l<a.length;l++){var d=n(a[l]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}a=c}}},659:e=>{"use strict";var t={};e.exports=function(e,n){var o=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(n)}},540:e=>{"use strict";e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,n)=>{"use strict";e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},825:e=>{"use strict";e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var o="";n.supports&&(o+="@supports (".concat(n.supports,") {")),n.media&&(o+="@media ".concat(n.media," {"));var r=void 0!==n.layer;r&&(o+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),o+=n.css,r&&(o+="}"),n.media&&(o+="}"),n.supports&&(o+="}");var a=n.sourceMap;a&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),t.styleTagTransform(o,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{"use strict";e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}}]);