<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>math_helper &mdash; rational-rc beta documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            rational-rc
          </a>
              <div class="version">
                0.2.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/features.html">Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Rational-RC API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/module_index.html">Modules</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial_index.html">Tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">rational-rc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">math_helper</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for math_helper</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">**Summary**</span>

<span class="sd">The helper module is designed to handle the repeated math operations that are not directly related to the mechanistic model calculation. These operations include the following</span>

<span class="sd">+ distribution sampling from a distribution (uniform, beta)</span>
<span class="sd">+ distribution curve fitting to data with an analytical or a numerical method</span>
<span class="sd">+ interpolation function for data tables</span>
<span class="sd">+ numerical integration for probability density functions</span>
<span class="sd">+ reliability probability calculation </span>
<span class="sd">+ statistical calculation to find mean and standard distribution ignoring not-a-number (nan).</span>
<span class="sd">+ figure sub-plotting</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="c1"># Declare first, as it provides global default value for helper functions</span>
<span class="n">N_SAMPLE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e5</span><span class="p">)</span>


<span class="c1"># logger</span>
<span class="c1"># log levels: NOTSET, DEBUG, INFO, WARNING, ERROR, and CRITICAL</span>
<span class="n">LOG_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2"> </span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;mylog.log&quot;</span><span class="p">,</span>
    <span class="c1"># level=logging.DEBUG,</span>
    <span class="nb">format</span><span class="o">=</span><span class="n">LOG_FORMAT</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span>
<span class="p">)</span>  <span class="c1"># set logging level here to work in jupyter notebook to override a possible default setting</span>


<span class="c1"># master helper functions</span>

<span class="c1"># Helper function</span>
<div class="viewcode-block" id="dropna"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.dropna">[docs]</a><span class="k">def</span> <span class="nf">dropna</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes NaN values from the input array.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span></div>


<div class="viewcode-block" id="get_mean"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.get_mean">[docs]</a><span class="k">def</span> <span class="nf">get_mean</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the mean of the input array, ignoring NaN values.&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_std"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.get_std">[docs]</a><span class="k">def</span> <span class="nf">get_std</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the standard deviation of the input array, ignoring NaN values.&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span></div>


<div class="viewcode-block" id="hist_custom"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.hist_custom">[docs]</a><span class="k">def</span> <span class="nf">hist_custom</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot a histogram with N_SAMPLE//100 bins, ignoring NaN values.&quot;&quot;&quot;</span>
    <span class="n">S_dropna</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">S</span><span class="p">)]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">S_dropna</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">S_dropna</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span></div>

<span class="c1"># Sampler functions</span>
<div class="viewcode-block" id="normal_custom"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.normal_custom">[docs]</a><span class="k">def</span> <span class="nf">normal_custom</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n_sample</span><span class="o">=</span><span class="n">N_SAMPLE</span><span class="p">,</span> <span class="n">non_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sample from a normal distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m : int or float</span>
<span class="sd">        Mean of the distribution.</span>
<span class="sd">    s : int or float</span>
<span class="sd">        Standard deviation of the distribution.</span>
<span class="sd">    n_sample : int</span>
<span class="sd">        Number of samples to generate. Default is a global variable N_SAMPLE.</span>
<span class="sd">    non_negative: bool</span>
<span class="sd">        If True, return a truncated distribution with no negative values. Default is False.</span>
<span class="sd">    plot : bool</span>
<span class="sd">        If True, plot a histogram of the generated samples. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy array</span>
<span class="sd">        Sample array from the normal distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_sample</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">non_negative</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">truncnorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_sample</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="beta_custom"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.beta_custom">[docs]</a><span class="k">def</span> <span class="nf">beta_custom</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n_sample</span><span class="o">=</span><span class="n">N_SAMPLE</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Draw samples from a general beta distribution.</span>

<span class="sd">    The general beta distribution is described by mean, standard deviation, lower bound, and upper bound.</span>
<span class="sd">    X ~ General Beta(a, b, loc=c, scale=d)</span>
<span class="sd">    Z ~ Standard Beta(alpha, beta)</span>
<span class="sd">    X = c + d * Z \n</span>
<span class="sd">    E(X) = c + d * E(Z) \n</span>
<span class="sd">    Var(X) = d^2 * Var(Z)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m : float</span>
<span class="sd">        Mean of the distribution.</span>
<span class="sd">    s : float</span>
<span class="sd">        Standard deviation of the distribution.</span>
<span class="sd">    a : float</span>
<span class="sd">        Lower bound (not the shape parameter a/alpha).</span>
<span class="sd">    b : float</span>
<span class="sd">        Upper bound (not the shape parameter b/beta).</span>
<span class="sd">    n_sample : int</span>
<span class="sd">        Number of samples to generate.</span>
<span class="sd">    plot : bool</span>
<span class="sd">        If True, plot a histogram of the generated samples. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy array</span>
<span class="sd">        Sample array from the distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Location:c and scale:d for General Beta (standard Beta range [0,1])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>

    <span class="c1"># Mean and variance for Z ~ standard beta</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">s</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">d</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># Shape parameters for Z ~ standard beta</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">var</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">mu</span><span class="p">)</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">mu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_sample</span><span class="p">)</span>

    <span class="c1"># Transfer back to General Beta</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">z</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">x</span></div>




<div class="viewcode-block" id="interp_extrap_f"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.interp_extrap_f">[docs]</a><span class="k">def</span> <span class="nf">interp_extrap_f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_find</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interpolate or extrapolate value from an array with a fitted 2nd-degree or 3rd-degree polynomial.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array-like</span>
<span class="sd">        Independent variable.</span>
<span class="sd">    y : array-like</span>
<span class="sd">        Function values.</span>
<span class="sd">    x_find : int or float or array-like</span>
<span class="sd">        Lookup x.</span>
<span class="sd">    plot : bool</span>
<span class="sd">        If True, plot curve fit and data points. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int or float or array-like</span>
<span class="sd">        Interpolated or extrapolated value(s). Raises a warning when extrapolation is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">func2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="c1"># 2nd-degree polynomial</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">func3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="c1"># 3rd-degree polynomial</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">d</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">x_find</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">x_find</span> <span class="o">&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning: extrapolation used&quot;</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

    <span class="c1"># Initial parameter guess to kick off the optimization</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;use func3: 3rd-degree polynomial&quot;</span><span class="p">)</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">func3</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">)</span>
        <span class="n">y_find</span> <span class="o">=</span> <span class="n">func3</span><span class="p">(</span><span class="n">x_find</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>
            <span class="n">_plot_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_plot_data</span><span class="p">,</span> <span class="n">func3</span><span class="p">(</span><span class="n">_plot_data</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">),</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_find</span><span class="p">,</span> <span class="n">y_find</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;interp/extrap data&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;use func2: 2nd-degree polynomial&quot;</span><span class="p">)</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">func2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">)</span>
        <span class="n">y_find</span> <span class="o">=</span> <span class="n">func2</span><span class="p">(</span><span class="n">x_find</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>
            <span class="n">_plot_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_plot_data</span><span class="p">,</span> <span class="n">func2</span><span class="p">(</span><span class="n">_plot_data</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">),</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_find</span><span class="p">,</span> <span class="n">y_find</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;interp/extrap data&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_find</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">y_find</span></div>


<div class="viewcode-block" id="find_similar_group"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.find_similar_group">[docs]</a><span class="k">def</span> <span class="nf">find_similar_group</span><span class="p">(</span><span class="n">item_list</span><span class="p">,</span> <span class="n">similar_group_size</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the most alike values in a list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    item_list : list</span>
<span class="sd">        A list to choose from.</span>
<span class="sd">    similar_group_size : int, optional</span>
<span class="sd">        Number of alike values. Default is 2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        A sublist with alike values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>

    <span class="n">combos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">item_list</span><span class="p">,</span> <span class="n">similar_group_size</span><span class="p">)))</span>
    <span class="n">ind_min</span> <span class="o">=</span> <span class="n">combos</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="n">similar_group</span> <span class="o">=</span> <span class="n">combos</span><span class="p">[</span><span class="n">ind_min</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">similar_group</span></div>


<div class="viewcode-block" id="sample_integral"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.sample_integral">[docs]</a><span class="k">def</span> <span class="nf">sample_integral</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Integrate Y over x, where every Y data point is a bunch of distribution samples.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Y : numpy array</span>
<span class="sd">        2D array.\n</span>
<span class="sd">        Column: y data point. \n</span>
<span class="sd">        Row: samples for each y data point.</span>
<span class="sd">    x : numpy array</span>
<span class="sd">        1D array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy array</span>
<span class="sd">        int_y_x : integral of y over x for all sampled data.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    [y0_sample1, y0_sample2\n</span>
<span class="sd">     y1_sample1, y1_sample2]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">simps</span>

    <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Y does not have the same number of data points as x&quot;</span><span class="p">)</span>
    <span class="n">int_y_x</span> <span class="o">=</span> <span class="n">simps</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">int_y_x</span></div>


<div class="viewcode-block" id="f_solve_poly2"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.f_solve_poly2">[docs]</a><span class="k">def</span> <span class="nf">f_solve_poly2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the two roots of the quadratic equation $ax^2+bx+c=0$</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">discriminant</span> <span class="o">=</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">discriminant</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The quadratic equation has complex roots&quot;</span><span class="p">)</span>

    <span class="n">sqrt_discriminant</span> <span class="o">=</span> <span class="n">discriminant</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">+</span> <span class="n">sqrt_discriminant</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">sqrt_discriminant</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span></div>


<span class="c1"># helper function</span>
<div class="viewcode-block" id="fit_distribution"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.fit_distribution">[docs]</a><span class="k">def</span> <span class="nf">fit_distribution</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fit_type</span><span class="o">=</span><span class="s2">&quot;kernel&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">axn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit data to a probability distribution function (parametric or numerical)</span>
<span class="sd">    and return a continuous random variable or a random variable represented by Gaussian kernels</span>
<span class="sd">    parametric : normal</span>
<span class="sd">    numerical : Gaussian kernels</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : array-like</span>
<span class="sd">        Sample data.</span>
<span class="sd">    fit_type : str, optional</span>
<span class="sd">        Fit type (&#39;kernel&#39; or &#39;normal&#39;), by default &#39;kernel&#39;.</span>
<span class="sd">    plot : bool, optional</span>
<span class="sd">        When True, create a plot with histogram and fitted PDF curve.</span>
<span class="sd">    xlabel : str, optional</span>
<span class="sd">        Label for the x-axis of the plot, by default &quot;&quot;.</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        Title of the plot, by default &quot;&quot;.</span>
<span class="sd">    axn : Any, optional</span>
<span class="sd">        Axes object for the plot, by default None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    instance of random variable </span>
<span class="sd">        Continuous random variable (stats.norm) if parametric normal is used,</span>
<span class="sd">        Gaussian kernel random variable (stats.gaussian_kde) if kernel is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">kde</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
        <span class="c1"># parametric, fit normal distribution</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;parametric, fit normal distribution&quot;</span><span class="p">)</span>

        <span class="c1"># fit a curve to the variates  mu is loc sigma is scale</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">floc</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="k">elif</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;kernel&quot;</span><span class="p">:</span>
        <span class="c1"># non-parametric, this creates the kernel, given an array it will estimate the probability over that values</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;non-parametric kernel fit&quot;</span><span class="p">)</span>
        <span class="n">s_dropna</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
        <span class="c1"># bandwidth selection:  gaussian_kde uses a rule of thumb, the default is Scott’s Rule.</span>
        <span class="n">kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">s_dropna</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;fit_type is not set correctly&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axn</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># bin size</span>
        <span class="n">dist_space</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">axn</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># plot pdf</span>
        <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="c1"># probability distribution</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">dist_space</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
            <span class="n">axn</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dist_space</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;kernel&quot;</span><span class="p">:</span>
            <span class="n">pdf_kde</span> <span class="o">=</span> <span class="n">kde</span><span class="p">(</span><span class="n">dist_space</span><span class="p">)</span>
            <span class="n">axn</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dist_space</span><span class="p">,</span> <span class="n">pdf_kde</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;kernel&quot;</span><span class="p">)</span>

        <span class="n">axn</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">axn</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;distribution density&quot;</span><span class="p">)</span>
        <span class="n">axn</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
        <span class="n">axn</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;kernel&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">kde</span></div>


<div class="viewcode-block" id="pf_RS"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.pf_RS">[docs]</a><span class="k">def</span> <span class="nf">pf_RS</span><span class="p">(</span><span class="n">R_info</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">R_distrib_type</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;pf_RS calculates the probability of failure Pf = P(R-S&lt;0), given the R(resistance) and S(load)</span>
<span class="sd">    with three methods and uses method 3 if it is checked &quot;OK&quot; with the other two</span>

<span class="sd">    1. crude monte carlo  </span>
<span class="sd">    2. numerical integral of g kernel fit</span>
<span class="sd">    3. R S integral: $\int\limits_{-\infty}^{\infty} F_R(x)f_S(x)dx$, reliability index (beta factor) is calculated with simple 1st order g.mean()/g.std()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    R_info : tuple, numpy array</span>
<span class="sd">        Distribution of Resistance, e.g., cover thickness, critical chloride content, tensile strength</span>
<span class="sd">        Can be an array or distribution parameters.</span>

<span class="sd">        R_distrib_type=&#39;normal&#39; -&gt; tuple(m, s) for normal (m: mean, s: standard deviation)</span>
<span class="sd">        </span>
<span class="sd">        R_distrib_type=&#39;beta&#39; -&gt; tuple(m, s, a, b) for (General) beta distribution</span>
<span class="sd">        m: mean, s: standard deviation, a, b: lower, upper bound</span>
<span class="sd">        </span>
<span class="sd">        R_distrib_type=&#39;array&#39; -&gt; array: for an undetermined distribution, will be treated numerically (R S integral is not applied)</span>

<span class="sd">    S : numpy array</span>
<span class="sd">        Distribution of load, e.g., carbonation depth, chloride content, tensile stress</span>
<span class="sd">        The distribution type is calculated S is usually not determined, can vary a lot in different cases, therefore fitted with kernel.</span>

<span class="sd">    R_distrib_type : str, optional</span>
<span class="sd">        &#39;normal&#39;, &#39;beta&#39;, &#39;array&#39;, by default &#39;normal&#39;</span>

<span class="sd">    plot : bool, optional</span>
<span class="sd">        Plot distribution, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (probability of failure, reliability index)</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">        For R as arrays, R S integral is not applied</span>
<span class="sd">        R S integration method: $P_f = P(R-S&lt;=0)=\int\limits_{-\infty}^{\infty}f_S(y) \int\limits_{-\infty}^{y}f_R(x)dxdy$</span>
<span class="sd">        The dual numerical integration seems too computationally expensive, so consider fitting R to an analytical distribution in future versions [TODO]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">integrate</span>

    <span class="n">R</span><span class="p">,</span> <span class="n">pf_RS</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">S_kde_fit</span> <span class="o">=</span> <span class="n">fit_distribution</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">fit_type</span><span class="o">=</span><span class="s2">&quot;kernel&quot;</span><span class="p">)</span>
    <span class="n">S_dropna</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">S</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">R_distrib_type</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
        <span class="c1"># R = (mu, std)</span>
        <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">R_info</span>
        <span class="n">R_distrib</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R_distrib</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">N_SAMPLE</span><span class="p">)</span>

        <span class="c1"># Calculate probability of failure</span>
        <span class="c1"># $P_f = P(R-S&lt;=0)=\int\limits_{-\infty}^{\infty} F_R(x)f_S(x)dx$</span>
        <span class="n">pf_RS</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">R_distrib</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">S_kde_fit</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S_dropna</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">R_distrib_type</span> <span class="o">==</span> <span class="s2">&quot;beta&quot;</span><span class="p">:</span>
        <span class="c1"># R = (m, s, a, b) a, b are lower and upper bound</span>
        <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">R_info</span>

        <span class="c1"># location:c and scale:d for General Beta (standard Beta range [0,1])</span>
        <span class="c1"># calculate loc and scale</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>

        <span class="c1"># mean and variance for </span>
        <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">s</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">d</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># shape params for Z~standard beta</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">var</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">mu</span><span class="p">)</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">mu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">R_distrib</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R_distrib</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">N_SAMPLE</span><span class="p">)</span>

        <span class="c1"># Calculate probability of failure</span>
        <span class="c1">#     $P_f = P(R-S&lt;=0)=\int\limits_{-\infty}^{\infty} F_R(x)f_S(x)dx$</span>
        <span class="n">pf_RS</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">R_distrib</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">S_kde_fit</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S_dropna</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">R_distrib_type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
        <span class="c1"># dual numerical integration is computationally expensive, consider fit R to analytical distribution in future versions.</span>
        <span class="c1"># plot condition to be updated in future versions.</span>

        <span class="c1">#         # use R array</span>
        <span class="c1">#         R_kde_fit = Fit_distrib(R, fit_type=&#39;kernel&#39;)</span>
        <span class="c1">#         R_dropna = R[~np.isnan(R)]</span>
        <span class="c1">#         # $P_f = P(R-S&lt;=0)=\int\limits_{-\infty}^{\infty}f_S(y) \int\limits_{-\infty}^{y}f_R(x)dxdy$</span>

        <span class="c1">#         def R_cdf_S_pdf(x, R_kde_fit, S_kde_fit):</span>
        <span class="c1">#             R_cdf = integrate.quad(lambda z: R_kde_fit(z)[0],0,x)[0] # kde_fit returns ([array needed]). therefore use lambda z kde(z)[0]</span>
        <span class="c1">#             S_pdf = S_kde_fit(x)[0]</span>
        <span class="c1">#             return R_cdf*S_pdf</span>

        <span class="c1">#         pf_RS = integrate.quad(R_cdf_S_pdf,0,S_dropna.max(), args=(R_kde_fit, S_kde_fit))[0]</span>
        <span class="n">R_distrib</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">R_distrib</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">pass</span>

    <span class="c1"># compare with</span>
    <span class="c1"># numerical g</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">R</span> <span class="o">-</span> <span class="n">S</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span>
    <span class="c1"># numerical kernel fit</span>
    <span class="n">g_kde_fit</span> <span class="o">=</span> <span class="n">fit_distribution</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">fit_type</span><span class="o">=</span><span class="s2">&quot;kernel&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pf_kde</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">g_kde_fit</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pf_sample</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">g</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">beta_factor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">g</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>  <span class="c1"># first order</span>

    <span class="c1"># check for tiny tail</span>
    <span class="k">if</span> <span class="n">pf_sample</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;warning: very small Pf &quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;warning: very small Pf &quot;</span><span class="p">)</span>

    <span class="c1"># check if pf_RS is the pf (should be)</span>
    <span class="n">best_2_of_3</span> <span class="o">=</span> <span class="n">find_similar_group</span><span class="p">([</span><span class="n">pf_sample</span><span class="p">,</span> <span class="n">pf_kde</span><span class="p">,</span> <span class="n">pf_RS</span><span class="p">],</span> <span class="n">similar_group_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pf_RS</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">best_2_of_3</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;warning: pf_RS is not used, double check&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Pf(g = R-S &lt; 0) from various methods</span><span class="se">\n</span><span class="s2">    sample count: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">    g integral: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">    R S integral: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">    beta_factor: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">pf_sample</span><span class="p">,</span> <span class="n">pf_kde</span><span class="p">,</span> <span class="n">pf_RS</span><span class="p">,</span> <span class="n">beta_factor</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Pf(g = R-S &lt; 0) from various methods</span><span class="se">\n</span><span class="s2">    sample count: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">    g integral: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">    R S integral: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">    beta_factor: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">pf_sample</span><span class="p">,</span> <span class="n">pf_kde</span><span class="p">,</span> <span class="n">pf_RS</span><span class="p">,</span> <span class="n">beta_factor</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pf(g = R-S &lt; 0) from various methods&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    sample count: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pf_sample</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    g integral: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pf_kde</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    R S integral: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pf_RS</span><span class="p">))</span>
        <span class="c1"># printmd(&#39;$\int\limits_{-\infty}^{\infty} F_R(x)f_S(x)dx$&#39;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    beta_factor: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beta_factor</span><span class="p">))</span>

        <span class="c1"># Plot R S</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="c1"># R</span>
        <span class="n">R_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">R</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R_plot</span><span class="p">,</span> <span class="n">R_distrib</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">R_plot</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">R</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">N_SAMPLE</span> <span class="o">//</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;R&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># S</span>
        <span class="n">S_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">S_dropna</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">S_dropna</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">S_plot</span><span class="p">,</span> <span class="n">S_kde_fit</span><span class="p">(</span><span class="n">S_plot</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">S_dropna</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">N_SAMPLE</span> <span class="o">//</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;S&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="s2">&quot;S: mean = </span><span class="si">{:.1f}</span><span class="s2"> stdev = </span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">S_dropna</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">S_dropna</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># plot g</span>
        <span class="n">g_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">g</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g_plot</span><span class="p">,</span> <span class="n">g_kde_fit</span><span class="p">(</span><span class="n">g_plot</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">g</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">N_SAMPLE</span> <span class="o">//</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;g=R-S&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">g_kde_fit</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">g_kde_fit</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">mean</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">g_kde_fit</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;${\mu}_g$&quot;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> 
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">g_kde_fit</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Limit-state P(g&lt;0)=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pf_RS</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">pf_RS</span><span class="p">,</span> <span class="n">beta_factor</span><span class="p">,</span> <span class="n">R_distrib</span><span class="p">,</span> <span class="n">S_kde_fit</span></div>


<div class="viewcode-block" id="plot_RS"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.plot_RS">[docs]</a><span class="k">def</span> <span class="nf">plot_RS</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">amplify</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;plot R S distribution vertically at a time to an axis</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model.R_distrib : scipy.stats._continuous_distns, normal or beta</span>
<span class="sd">                      calculated in Pf_RS() through model.postproc()</span>
<span class="sd">    model.S_kde_fit : stats.gaussian_kde</span>
<span class="sd">                      calculated in Pf_RS() through model.postproc()</span>
<span class="sd">                      distribution of load, e.g. carbonation depth, chloride content, tensile     stress. The distrubtion type is calculated S is usually not determined, can vary a lot in different cases, therefore fitted with kernel</span>

<span class="sd">    model.S : numpy array</span>
<span class="sd">              load, e.g. carbonation depth, chloride content, tensile stress</span>
<span class="sd">    ax : axis</span>
<span class="sd">    t_offset : time offset to move the plot along the t-axis. default is zero</span>
<span class="sd">    amplify : scale the height of the pdf plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">R_distrib</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">R_distrib</span>
    <span class="n">S_kde_fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">S_kde_fit</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">S</span>

    <span class="n">S_dropna</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">S</span><span class="p">)]</span>
    <span class="c1"># Plot R S</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">R_distrib</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">N_SAMPLE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="c1"># R</span>
    <span class="n">R_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">R</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R_distrib</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">R_plot</span><span class="p">)</span> <span class="o">*</span> <span class="n">amplify</span> <span class="o">+</span> <span class="n">t_offset</span><span class="p">,</span> <span class="n">R_plot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span>
        <span class="n">R_plot</span><span class="p">,</span>
        <span class="n">t_offset</span><span class="p">,</span>
        <span class="n">R_distrib</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">R_plot</span><span class="p">)</span> <span class="o">*</span> <span class="n">amplify</span> <span class="o">+</span> <span class="n">t_offset</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;R&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># to avoid plotting large S with very small probability</span>
    <span class="n">S_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">S_dropna</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">S_dropna</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">S_dropna</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">S_kde_fit</span><span class="p">(</span><span class="n">S_plot</span><span class="p">)</span> <span class="o">*</span> <span class="n">amplify</span> <span class="o">+</span> <span class="n">t_offset</span><span class="p">,</span> <span class="n">S_plot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span>
        <span class="n">S_plot</span><span class="p">,</span>
        <span class="n">t_offset</span><span class="p">,</span>
        <span class="n">S_kde_fit</span><span class="p">(</span><span class="n">S_plot</span><span class="p">)</span> <span class="o">*</span> <span class="n">amplify</span> <span class="o">+</span> <span class="n">t_offset</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;S&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="c1"># additional helper function</span>
<div class="viewcode-block" id="find_mean"><a class="viewcode-back" href="../api/modules/math_helper.html#math_helper.find_mean">[docs]</a><span class="k">def</span> <span class="nf">find_mean</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">confidence_one_tailed</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;return the mean value of a unknown normal distribution</span>
<span class="sd">    based on the given value at a known one-tailed confidence level(default 95%)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    val : float</span>
<span class="sd">         cut-off value</span>
<span class="sd">    s : standard deviation</span>
<span class="sd">    confidence_one_tailed : confidence level</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        mean value of the unknown normal distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">confidence_one_tailed</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;object function to be solved&quot;&quot;&quot;</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cutoff</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence_one_tailed</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">fsolve</span>

    <span class="n">mean</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">confidence_one_tailed</span><span class="p">))[</span>
        <span class="mi">0</span>
    <span class="p">]</span>  <span class="c1"># use val as initial guess</span>
    <span class="k">return</span> <span class="n">mean</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Gang Li.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>